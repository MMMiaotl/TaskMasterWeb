{% extends "base.html" %}

{% block title %}{{ task.title }} - 对你的某任务的回应{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- 任务标题和基本信息 -->
        <div class="col-12 mb-4">
            <div class="card shadow-sm border-0 rounded-lg">
                <div class="card-header bg-gradient-primary text-dark py-3">
                    <h1 class="card-title h3 mb-0">{{ task.title }}</h1>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-primary me-2">
                                <i class="fas fa-map-marker-alt me-1"></i>{{ task.location }}
                            </span>
                            <span class="badge bg-info me-2">
                                <i class="fas fa-calendar-alt me-1"></i>{{ task.created_at|datetimeformat }}
                            </span>
                        </div>
                        <div>
                            {% if task.status == 0 %}
                            <span class="badge bg-warning text-dark">
                                <i class="fas fa-hourglass-start me-1"></i>等待接单
                            </span>
                            {% elif task.status == 1 %}
                            <span class="badge bg-info">
                                <i class="fas fa-hourglass-half me-1"></i>等待执行
                            </span>
                            {% elif task.status == 2 %}
                            <span class="badge bg-primary">
                                <i class="fas fa-check-circle me-1"></i>任务完成
                            </span>
                            {% elif task.status == 3 %}
                            <span class="badge bg-success">
                                <i class="fas fa-money-bill-wave me-1"></i>付款完成
                            </span>
                            {% elif task.status == 4 %}
                            <span class="badge bg-danger">
                                <i class="fas fa-times-circle me-1"></i>已取消
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 左侧导航栏 -->
        <div class="col-md-3">
            <!-- 我的聊天 -->
            <div class="card shadow-sm border-0 rounded-lg mb-3">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-comments me-2"></i>我的聊天
                        <span class="badge bg-danger float-end">{{ unread_messages_count }}</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="chats-list" style="max-height: 300px; overflow-y: auto;">
                        {% if conversations %}
                            {% for conv in conversations %}
                                <div class="chat-item p-3 border-bottom {% if conv.has_unread %}bg-light{% endif %}" data-conversation-id="{{ conv.id }}">
                                    <div class="d-flex align-items-center position-relative">
                                        <img src="{{ conv.pro_avatar }}" alt="{{ conv.pro_name }}" class="rounded-circle" width="40">
                                        <div class="ms-3 flex-grow-1">
                                            <h6 class="mb-1">{{ conv.pro_name }}</h6>
                                            <p class="text-muted mb-0 text-truncate" style="max-width: 140px;">{{ conv.last_message_preview }}</p>
                                        </div>
                                        <div class="text-end">
                                            <small class="text-muted d-block">{{ conv.last_message_time | datetimeformat }}</small>
                                            {% if conv.has_unread %}
                                                <span class="badge bg-danger rounded-pill mt-1">{{ conv.unread_count }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center p-3">
                                <p class="text-muted mb-0">您的任务尚未收到任何对话</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 感兴趣的专业人士 -->
            <div class="card shadow-sm border-0 rounded-lg mb-3">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-tie me-2"></i>感兴趣的专业人士
                        <span class="badge bg-primary float-end">{{ interested_pros_count }}</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="pros-list interested-pros-list" style="max-height: 300px; overflow-y: auto;">
                        {% if interested_pros %}
                            {% for pro in interested_pros %}
                            <div class="pro-item p-3 border-bottom" data-pro-id="{{ pro.id }}" data-tab-id="interestedPros">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <img src="{{ pro.avatar }}" alt="{{ pro.name }}的头像" 
                                            class="rounded-circle" width="40">
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0">{{ pro.name }}</h6>
                                        <div class="text-muted small">
                                            <i class="fas fa-star text-warning"></i> {{ pro.rating }}
                                            <span class="mx-1">|</span>
                                            <i class="fas fa-briefcase"></i> {{ pro.completed_jobs }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center p-3">
                                <p class="text-muted mb-0">暂时没有专业人士对此任务感兴趣</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 符合要求的专业人士 -->
            <div class="card shadow-sm border-0 rounded-lg mb-3">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-check-circle me-2"></i>符合你要求的专业人士
                        <span class="badge bg-success float-end">{{ matching_pros_count }}</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="pros-list matching-pros-list" style="max-height: 300px; overflow-y: auto;">
                        {% if matching_pros %}
                            {% for pro in matching_pros %}
                            <div class="pro-item p-3 border-bottom" data-pro-id="{{ pro.id }}" data-tab-id="matchingPros">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <img src="{{ pro.avatar }}" alt="{{ pro.name }}的头像" 
                                            class="rounded-circle" width="40">
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0">{{ pro.name }}</h6>
                                        <div class="text-muted small">
                                            <i class="fas fa-star text-warning"></i> {{ pro.rating }}
                                            <span class="mx-1">|</span>
                                            <i class="fas fa-map-marker-alt"></i> {{ pro.distance }}km
                                        </div>
                                        <div class="mt-1">
                                            <span class="badge bg-success">匹配度: {{ pro.match_score }}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center p-3">
                                <p class="text-muted mb-0">我们正在为您寻找符合要求的专业人士</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 工作详情入口 -->
            <div class="card shadow-sm border-0 rounded-lg">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>工作详情
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid">
                        <button class="btn btn-outline-primary" id="view-task-details">
                            <i class="fas fa-eye me-2"></i>查看完整工作详情
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧内容区域 -->
        <div class="col-md-9">
            <div class="card shadow-sm border-0 rounded-lg">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0" id="content-area-title">聊天详情</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="back-to-chat" style="display:none;">
                            <i class="fas fa-arrow-left me-1"></i>返回聊天
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="content-section" id="chat-area-container">
                        <div class="row">
                            <!-- 聊天窗口 -->
                            <div class="col-12">
                                <div class="chat-window" id="chat-window">
                                    <!-- 当没有选中对话时显示 -->
                                    <div class="chat-placeholder text-center p-5">
                                        <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                        <p class="lead text-muted">请选择一个对话开始聊天</p>
                                    </div>
                                    
                                    <!-- 对话消息容器 -->
                                    <div class="chat-messages overflow-auto p-3" style="height: calc(100vh - 400px);">
                                        <!-- 消息将在这里动态加载 -->
                                    </div>
                                    
                                    <!-- 消息输入框 -->
                                    <div class="chat-input-area mt-3 p-3 bg-light rounded">
                                        <div class="input-group">
                                            <input type="text" id="message-input" class="form-control" placeholder="输入消息...">
                                            <button class="btn btn-primary" id="send-message-btn">
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="content-section d-none" id="pro-details-area">
                        <div class="pro-details">
                            <div class="text-center p-5 pro-placeholder">
                                <i class="fas fa-user-tie fa-3x text-muted mb-3"></i>
                                <p>正在加载专业人士资料...</p>
                            </div>
                            <div class="pro-profile d-none">
                                <!-- 专业人士资料 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 任务详情模态框 -->
<div class="modal fade" id="taskDetailsModal" tabindex="-1" aria-labelledby="taskDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskDetailsModalLabel">{{ task.title }} - 工作详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="task-info mb-4">
                    <h6 class="fw-bold">描述</h6>
                    <p>{{ task.description }}</p>
                </div>
                
                <div class="task-info mb-4">
                    <h6 class="fw-bold">基本信息</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-map-marker-alt text-primary"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <small class="text-muted">位置</small>
                                    <p class="mb-0">{{ task.location }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-calendar-alt text-primary"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <small class="text-muted">期望日期</small>
                                    <p class="mb-0">{{ task.deadline|datetimeformat }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-clock text-primary"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <small class="text-muted">发布时间</small>
                                    <p class="mb-0">{{ task.created_at|datetimeformat }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-tag text-primary"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <small class="text-muted">预算</small>
                                    <p class="mb-0">¥{{ task.budget }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if task.attachments %}
                <div class="task-info mb-4">
                    <h6 class="fw-bold">附件</h6>
                    <div class="row">
                        {% for attachment in task.attachments %}
                        <div class="col-md-3 mb-3">
                            <div class="card">
                                <img src="{{ attachment.url }}" class="card-img-top" alt="附件图片">
                                <div class="card-body p-2">
                                    <a href="{{ attachment.url }}" class="btn btn-sm btn-outline-primary w-100" download>
                                        <i class="fas fa-download me-1"></i>下载
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <a href="{{ url_for('task.edit_task', task_id=task.id) }}" class="btn btn-outline-primary">
                    <i class="fas fa-edit me-1"></i>编辑任务
                </a>
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#cancelTaskModal" data-bs-dismiss="modal">
                    <i class="fas fa-times-circle me-1"></i>取消任务
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 取消任务确认模态框 -->
<div class="modal fade" id="cancelTaskModal" tabindex="-1" aria-labelledby="cancelTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelTaskModalLabel">确认取消任务</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>您确定要取消此任务吗？此操作无法撤销。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <form action="{{ url_for('task.cancel_task', task_id=task.id) }}" method="post">
                    <button type="submit" class="btn btn-danger">确认取消</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
{{ super() }}
<script>
    // 存储当前任务ID和当前用户ID
    const taskId = "{{ task.id }}";
    const currentUserId = "{{ current_user.id }}";
    let csrfToken = "{{ csrf_token }}";
    
    // 添加全局错误处理
    window.addEventListener('error', function(event) {
        console.error('全局错误:', event.error.message);
        console.error('错误堆栈:', event.error.stack);
    });

    // 添加调试日志函数
    function logDebug(message, data) {
        console.log(`[DEBUG] ${message}`, data || '');
    }

    function logError(message, error) {
        console.error(`[ERROR] ${message}`, error || '');
        if (error && error.stack) {
            console.error(`[ERROR STACK] ${error.stack}`);
        }
    }
    
    // 单独记录错误堆栈的函数
    function logErrorStack(error) {
        if (error && error.stack) {
            console.error(`[ERROR STACK详情] ${error.stack}`);
        } else {
            console.error('[ERROR] 无堆栈信息可用');
        }
    }
    
    // 刷新CSRF令牌
    async function refreshCsrfToken() {
        logDebug('获取最新CSRF令牌');
        try {
            // 获取CSRF令牌
            const csrfMeta = document.querySelector('meta[name="csrf-token"]');
            if (csrfMeta) {
                return csrfMeta.content;
            } else {
                logError('未找到CSRF令牌元标签');
                return '';
            }
        } catch (error) {
            logError('获取CSRF令牌失败', error);
            logErrorStack(error);
            return '';
        }
    }
    
    // 创建带有CSRF令牌的通用fetch包装函数
    async function fetchWithCsrf(url, options = {}) {
        try {
            // 确保options.headers存在
            options.headers = options.headers || {};
            
            // 如果是POST/PUT/DELETE等修改请求，需要CSRF令牌
            if (['POST', 'PUT', 'DELETE', 'PATCH'].includes(options.method)) {
                // 添加CSRF令牌到请求头
                options.headers['X-CSRFToken'] = csrfToken;
                options.credentials = 'same-origin';
                
                // 如果CSRF令牌为空或过期，先刷新令牌
                if (!csrfToken) {
                    csrfToken = await refreshCsrfToken();
                    options.headers['X-CSRFToken'] = csrfToken;
                }
            }
            
            // 发送请求
            const response = await fetch(url, options);
            
            // 检查是否需要刷新CSRF令牌（如果返回403和CSRF错误）
            if (response.status === 403) {
                const responseText = await response.text();
                if (responseText.includes('CSRF') || responseText.includes('csrf')) {
                    logDebug('CSRF令牌可能已过期，正在刷新');
                    await refreshCsrfToken();
                    
                    // 使用新令牌重试请求
                    options.headers['X-CSRFToken'] = csrfToken;
                    return fetch(url, options);
                }
            }
            
            return response;
        } catch (error) {
            logError('fetchWithCsrf请求出错', error);
            throw error;
        }
    }
    
    // 初始化日志
    logDebug('页面初始化', {taskId, currentUserId});
    
    // 处理聊天列表点击事件
    document.querySelectorAll('.chat-item').forEach(item => {
        item.addEventListener('click', function() {
            const conversationId = this.dataset.conversationId;
            logDebug('点击聊天项', {
                conversationId: conversationId,
                element: this.outerHTML,
                hasClass: this.classList.contains('chat-item')
            });
            
            // 移除所有聊天项的活动状态
            document.querySelectorAll('.chat-item').forEach(el => {
                el.classList.remove('active-chat');
                logDebug('移除活动状态', {element: el.outerHTML});
            });
            
            // 添加活动状态到当前项
            this.classList.add('active-chat');
            logDebug('添加活动状态后', {
                hasActiveClass: this.classList.contains('active-chat')
            });
            
            // 显示聊天区域，隐藏专业人士详情区域
            document.getElementById('chat-area-container').classList.remove('d-none');
            document.getElementById('pro-details-area').classList.add('d-none');
            document.getElementById('content-area-title').textContent = '聊天详情';
            document.getElementById('back-to-chat').style.display = 'none';
            
            // 加载对话详情
            loadConversation(conversationId);
            
            // 检查聊天区域元素
            const chatPlaceholder = document.querySelector('.chat-placeholder');
            const chatMessages = document.querySelector('.chat-messages');
            const chatInputArea = document.querySelector('.chat-input-area');
            
            logDebug('聊天区域元素', {
                chatPlaceholder: chatPlaceholder ? true : false,
                chatMessages: chatMessages ? true : false,
                chatInputArea: chatInputArea ? true : false
            });
            
            // 显示对话区域
            if (chatPlaceholder) chatPlaceholder.classList.add('d-none');
            if (chatMessages) chatMessages.classList.remove('d-none');
            if (chatInputArea) chatInputArea.classList.remove('d-none');
            
            // 设置当前活跃对话ID到发送按钮的data属性
            document.getElementById('send-message-btn').setAttribute('data-conversation-id', conversationId);
        });
    });
    
    // 处理专业人士列表点击事件
    document.addEventListener('DOMContentLoaded', function() {
        // 确保DOM完全加载后再绑定事件
        document.querySelectorAll('.pro-item').forEach(item => {
            item.addEventListener('click', function() {
                try {
                    const proId = this.getAttribute('data-pro-id');
                    const tabType = this.getAttribute('data-tab-id');
                    logDebug('点击专业人士项', {proId, tabType});
                    
                    if (!proId || !tabType) {
                        logError('专业人士项缺少必要属性', {
                            element: this.outerHTML,
                            proId: proId,
                            tabType: tabType
                        });
                        return;
                    }
                    
                    // 获取必要的DOM元素
                    const chatAreaContainer = document.getElementById('chat-area-container');
                    const proDetailsArea = document.getElementById('pro-details-area');
                    const contentAreaTitle = document.getElementById('content-area-title');
                    const backToChat = document.getElementById('back-to-chat');
                    
                    // 检查元素是否存在
                    if (!chatAreaContainer || !proDetailsArea || !contentAreaTitle || !backToChat) {
                        logError('找不到必要的DOM元素', {
                            chatAreaContainer: chatAreaContainer ? '存在' : '不存在',
                            proDetailsArea: proDetailsArea ? '存在' : '不存在',
                            contentAreaTitle: contentAreaTitle ? '存在' : '不存在',
                            backToChat: backToChat ? '存在' : '不存在'
                        });
                        return;
                    }
                    
                    // 显示专业人士详情区域，隐藏其他区域
                    chatAreaContainer.classList.add('d-none');
                    proDetailsArea.classList.remove('d-none');
                    contentAreaTitle.textContent = '专业人士详情';
                    backToChat.style.display = 'block';
                    
                    // 高亮选中的专业人士
                    document.querySelectorAll('.pro-item').forEach(i => 
                        i.classList.remove('bg-primary', 'text-white'));
                    this.classList.add('bg-primary', 'text-white');
                    
                    // 加载专业人士详情
                    loadProDetails(proId, tabType);
                } catch (error) {
                    logError('处理专业人士项点击事件出错', error);
                    alert('加载专业人士详情时出错: ' + error.message);
                }
            });
        });
        
        // 返回聊天区域按钮
        const backToChat = document.getElementById('back-to-chat');
        if (backToChat) {
            backToChat.addEventListener('click', function() {
                const chatAreaContainer = document.getElementById('chat-area-container');
                const proDetailsArea = document.getElementById('pro-details-area');
                const contentAreaTitle = document.getElementById('content-area-title');
                
                if (chatAreaContainer && proDetailsArea && contentAreaTitle) {
                    chatAreaContainer.classList.remove('d-none');
                    proDetailsArea.classList.add('d-none');
                    contentAreaTitle.textContent = '聊天详情';
                    this.style.display = 'none';
                } else {
                    logError('返回聊天区域时找不到必要的DOM元素');
                }
            });
        } else {
            logError('找不到返回聊天区域按钮');
        }
        
        // 工作详情按钮
        const viewTaskDetails = document.getElementById('view-task-details');
        if (viewTaskDetails) {
            viewTaskDetails.addEventListener('click', function() {
                const taskDetailsModal = document.getElementById('taskDetailsModal');
                if (taskDetailsModal && typeof bootstrap !== 'undefined') {
                    try {
                        const modal = new bootstrap.Modal(taskDetailsModal);
                        modal.show();
                    } catch (error) {
                        logError('显示任务详情模态框失败', error);
                        // 尝试使用jQuery方式显示模态框
                        try {
                            if (typeof $ !== 'undefined') {
                                $(taskDetailsModal).modal('show');
                            } else {
                                // 最后的尝试，使用原生方式
                                taskDetailsModal.classList.add('show');
                                taskDetailsModal.style.display = 'block';
                                document.body.classList.add('modal-open');
                                
                                // 创建背景遮罩
                                const backdrop = document.createElement('div');
                                backdrop.className = 'modal-backdrop fade show';
                                document.body.appendChild(backdrop);
                            }
                        } catch (jqError) {
                            logError('尝试备用方式显示模态框也失败', jqError);
                        }
                    }
                } else {
                    logError('找不到任务详情模态框或bootstrap未定义');
                }
            });
        } else {
            logError('找不到工作详情按钮');
        }
    });
    
    // 加载对话内容的函数
    function loadConversation(conversationId) {
        logDebug('开始加载对话', {conversationId, taskId, currentUserId});
        
        try {
            // 解析对话ID，获取用户ID
            const userIds = conversationId.split('_');
            if (userIds.length !== 2) {
                logError('无效的对话ID格式', {conversationId});
                return;
            }
            
            const otherUserId = userIds[0] === currentUserId ? userIds[1] : userIds[0];
            logDebug('解析对话ID', {userIds, currentUserId, otherUserId});
            
            // 确保taskId存在
            if (!taskId) {
                logError('任务ID不存在');
                return;
            }
            
            // 确保otherUserId是数字
            const numericOtherUserId = parseInt(otherUserId);
            if (isNaN(numericOtherUserId)) {
                logError('无效的用户ID', {otherUserId});
                return;
            }
            
            // 确保taskId是数字
            const numericTaskId = parseInt(taskId);
            if (isNaN(numericTaskId)) {
                logError('无效的任务ID', {taskId});
                return;
            }
            
            const url = `/message/api/messages?task_id=${numericTaskId}&other_user_id=${numericOtherUserId}`;
            logDebug('构建API请求URL', {url, numericTaskId, numericOtherUserId});
            
            const messagesContainer = document.querySelector('.chat-messages');
            
            if (!messagesContainer) {
                logError('找不到消息容器元素', {selector: '.chat-messages'});
                return;
            }
            
            // 显示加载状态
            messagesContainer.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">加载聊天记录中...</p></div>';
            
            // 显示聊天窗口，隐藏占位符
            const chatPlaceholder = document.querySelector('.chat-placeholder');
            const chatInputArea = document.querySelector('.chat-input-area');
            const messageInput = document.getElementById('message-input');
            
            logDebug('聊天区域元素状态', {
                chatPlaceholder: chatPlaceholder ? {
                    exists: true,
                    isHidden: chatPlaceholder.classList.contains('d-none')
                } : 'not found',
                messagesContainer: {
                    exists: true,
                    isHidden: messagesContainer.classList.contains('d-none')
                },
                chatInputArea: chatInputArea ? {
                    exists: true,
                    isHidden: chatInputArea.classList.contains('d-none')
                } : 'not found',
                messageInput: messageInput ? {
                    exists: true,
                    disabled: messageInput.disabled
                } : 'not found'
            });
            
            if (chatPlaceholder) chatPlaceholder.classList.add('d-none');
            if (messagesContainer) messagesContainer.classList.remove('d-none');
            if (chatInputArea) chatInputArea.classList.remove('d-none');
            
            // 确保输入框可用
            if (messageInput) {
                messageInput.disabled = false;
                messageInput.focus();
            }
            
            // 发送AJAX请求
            logDebug('发送API请求', {url});
            fetchWithCsrf(url)
                .then(response => {
                    logDebug('获取API响应', {status: response.status, ok: response.ok, statusText: response.statusText});
                    if (!response.ok) {
                        return response.text().then(text => {
                            logError('API响应错误', {status: response.status, text: text});
                            throw new Error(`请求失败，状态码: ${response.status}, 错误信息: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    logDebug('解析API响应数据', {
                        messagesCount: data.messages ? data.messages.length : 0, 
                        unreadCount: data.unread_count || 0,
                        firstMessage: data.messages && data.messages.length > 0 ? {
                            sender_id: data.messages[0].sender_id,
                            content: data.messages[0].content.substring(0, 50) + '...',
                            isCurrentUser: data.messages[0].sender_id === parseInt(currentUserId)
                        } : 'no messages',
                        error_info: data.error_info || null
                    });
                    
                    // 检查是否有错误信息
                    if (data.error_info) {
                        logError('API返回错误信息', {error_info: data.error_info});
                        messagesContainer.innerHTML = `<div class="alert alert-warning">
                            <p>暂无聊天记录</p>
                            <small class="text-muted">${data.error_info}</small>
                        </div>`;
                        return;
                    }
                    
                    // 检查是否有错误
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // 检查消息数组是否存在
                    if (!data.messages || !Array.isArray(data.messages)) {
                        throw new Error('API返回的数据格式不正确，缺少messages数组');
                    }
                    
                    // 清空容器
                    messagesContainer.innerHTML = '';
                    
                    // 如果没有消息，显示提示
                    if (data.messages.length === 0) {
                        messagesContainer.innerHTML = '<div class="text-center p-5"><p class="text-muted">暂无聊天记录</p></div>';
                        return;
                    }
                    
                    // 渲染消息
                    data.messages.forEach((message, index) => {
                        try {
                            const isCurrentUser = message.sender_id === parseInt(currentUserId);
                            logDebug(`渲染消息 ${index}`, {
                                sender_id: message.sender_id,
                                current_user_id: currentUserId,
                                isCurrentUser: isCurrentUser,
                                content_preview: message.content.substring(0, 30) + '...'
                            });
                            
                            const messageHtml = `
                                <div class="message ${isCurrentUser ? 'message-outgoing' : 'message-incoming'} mb-3">
                                    <div class="d-flex align-items-end ${isCurrentUser ? 'justify-content-end' : ''}">
                                        ${!isCurrentUser ? `<img src="${data.other_user.avatar || '/static/images/default-avatar.jpg'}" class="avatar-sm rounded-circle me-2" alt="${data.other_user.name}">` : ''}
                                        <div class="message-content ${isCurrentUser ? 'bg-primary text-white' : 'bg-light'} p-3 rounded">
                                            ${message.content}
                                            <div class="message-time small ${isCurrentUser ? 'text-light' : 'text-muted'} mt-1">
                                                ${formatDateTime(message.created_at)}
                                            </div>
                                        </div>
                                        ${isCurrentUser ? `<img src="${data.current_user.avatar || '/static/images/default-avatar.jpg'}" class="avatar-sm rounded-circle ms-2" alt="${data.current_user.name}">` : ''}
                                    </div>
                                </div>
                            `;
                            messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
                        } catch (error) {
                            logError(`渲染消息出错 (索引: ${index})`, error);
                        }
                    });
                    
                    // 滚动到底部
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                    // 标记为已读
                    if (data.unread_count > 0) {
                        markConversationAsRead(otherUserId);
                    }
                    
                    // 更新未读消息数
                    updateUnreadCount();
                    
                    // 刷新聊天列表以更新未读状态
                    refreshChatList();
                    
                    // 确保输入框可用并获取焦点
                    const messageInput = document.getElementById('message-input');
                    if (messageInput) {
                        messageInput.disabled = false;
                        messageInput.focus();
                    }
                })
                .catch(error => {
                    logError('加载对话失败', error);
                    messagesContainer.innerHTML = `<div class="alert alert-danger">加载聊天记录失败: ${error.message}</div>`;
                });
        } catch (error) {
            logError('loadConversation函数执行出错', error);
        }
    }
    
    // 加载专业人士详情的函数
    function loadProDetails(proId, tabType) {
        logDebug('开始加载专业人士详情', {proId, tabType});
        
        // 显示加载状态，但使用更友好的UI
        const profileContainer = document.querySelector('.pro-profile');
        const placeholderContainer = document.querySelector('.pro-placeholder');
        
        if (!profileContainer || !placeholderContainer) {
            logError('找不到专业人士资料容器元素', {
                profileContainer: profileContainer ? '存在' : '不存在',
                placeholderContainer: placeholderContainer ? '存在' : '不存在'
            });
            return;
        }
        
        // 显示更友好的加载状态
        placeholderContainer.classList.remove('d-none');
        profileContainer.classList.add('d-none');
        placeholderContainer.innerHTML = `
            <div class="text-center p-4">
                <div class="spinner-border text-primary spinner-border-sm me-2" role="status"></div>
                <span>正在加载专业人士资料...</span>
                <div class="progress mt-3" style="height: 5px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                         role="progressbar" style="width: 100%"></div>
                </div>
            </div>
        `;
        
        // 创建一个缓存键
        const cacheKey = `pro_${proId}_${tabType}`;
        
        // 检查是否有缓存数据
        const cachedData = sessionStorage.getItem(cacheKey);
        if (cachedData) {
            try {
                const data = JSON.parse(cachedData);
                logDebug('使用缓存的专业人士数据', {proId, tabType});
                // 使用短延迟显示缓存数据，让用户感知到加载过程
                setTimeout(() => displayProData(data, tabType), 300);
                
                // 在后台仍然请求新数据以更新缓存
                fetchProDataAndUpdateCache(proId, tabType, cacheKey);
                return;
            } catch (e) {
                logError('解析缓存数据失败', e);
                // 继续正常加载流程
            }
        }
        
        // 首先尝试从页面数据中获取专业人士信息作为快速显示
        let proData = extractProDataFromPage(proId, tabType);
        
        if (proData) {
            // 立即显示从页面提取的基本数据
            displayProData(proData, tabType);
            
            // 然后在后台获取完整数据
            fetchProDataAndUpdateCache(proId, tabType, cacheKey);
        } else {
            // 如果没有页面数据，直接获取API数据
            fetchProDataAndUpdateCache(proId, tabType, cacheKey);
        }
    }
    
    // 从页面元素中提取专业人士数据
    function extractProDataFromPage(proId, tabType) {
        try {
            let proData = null;
            
            if (tabType === 'interestedPros') {
                const proElements = document.querySelectorAll(`.pro-item[data-pro-id="${proId}"][data-tab-id="interestedPros"]`);
                if (proElements && proElements.length > 0) {
                    const proElement = proElements[0];
                    if (proElement) {
                        const nameElement = proElement.querySelector('h6.mb-0');
                        const ratingElement = proElement.querySelector('.fas.fa-star.text-warning');
                        const jobsElement = proElement.querySelector('.fas.fa-briefcase');
                        
                        proData = {
                            id: proId,
                            name: nameElement ? nameElement.textContent.trim() : '未知专业人士',
                            rating: ratingElement ? parseFloat(ratingElement.parentElement.textContent.trim() || '0') : 0,
                            completed_jobs: jobsElement ? parseInt(jobsElement.parentElement.textContent.trim().replace(/\D/g, '') || '0') : 0,
                            profession: '',
                            skills: [],
                            contact: '',
                            description: '正在加载完整资料...',
                            _fromPage: true
                        };
                    }
                }
            } else if (tabType === 'matchingPros') {
                const proElements = document.querySelectorAll(`.pro-item[data-pro-id="${proId}"][data-tab-id="matchingPros"]`);
                if (proElements && proElements.length > 0) {
                    const proElement = proElements[0];
                    if (proElement) {
                        const nameElement = proElement.querySelector('h6.mb-0');
                        const ratingElement = proElement.querySelector('.fas.fa-star.text-warning');
                        const distanceElement = proElement.querySelector('.fas.fa-map-marker-alt');
                        const matchScoreElement = proElement.querySelector('.badge.bg-success');
                        
                        proData = {
                            id: proId,
                            name: nameElement ? nameElement.textContent.trim() : '未知专业人士',
                            rating: ratingElement ? parseFloat(ratingElement.parentElement.textContent.trim() || '0') : 0,
                            distance: distanceElement ? parseFloat(distanceElement.parentElement.textContent.trim().replace(/[^\d.]/g, '') || '0') : 0,
                            match_score: matchScoreElement ? parseInt(matchScoreElement.textContent.replace(/\D/g, '') || '0') : 0,
                            profession: '',
                            skills: [],
                            contact: '',
                            description: '正在加载完整资料...',
                            _fromPage: true
                        };
                    }
                }
            }
            
            return proData;
        } catch (error) {
            logError('从页面元素提取专业人士数据失败', error);
            return null;
        }
    }
    
    // 从API获取专业人士数据并更新缓存
    function fetchProDataAndUpdateCache(proId, tabType, cacheKey) {
        // 尝试不同的API路径
        const urls = [
            `/task/api/professionals/${proId}?task_id=${taskId}`,
            `/api/professionals/${proId}?task_id=${taskId}`,
            `/api/tasks/${taskId}/professionals/${proId}`
        ];
        
        // 使用Promise.any尝试所有URL，取第一个成功的结果
        const fetchPromises = urls.map(url => {
            return new Promise((resolve, reject) => {
                logDebug(`尝试API路径`, {url});
                
                fetchWithCsrf(url)
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(`请求失败，状态码: ${response.status}, 错误信息: ${text}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        logDebug('获取专业人士数据成功', {url, data});
                        resolve(data);
                    })
                    .catch(error => {
                        logError(`API路径 ${url} 失败`, error);
                        reject(error);
                    });
            });
        });
        
        // 使用Promise.allSettled替代Promise.any，以便在所有请求都失败时也能处理
        Promise.allSettled(fetchPromises)
            .then(results => {
                // 查找第一个成功的结果
                const successResult = results.find(r => r.status === 'fulfilled');
                
                if (successResult) {
                    const data = successResult.value;
                    
                    // 缓存数据
                    try {
                        sessionStorage.setItem(cacheKey, JSON.stringify(data));
                        logDebug('专业人士数据已缓存', {cacheKey});
                    } catch (e) {
                        logError('缓存专业人士数据失败', e);
                    }
                    
                    // 显示数据
                    displayProData(data, tabType);
                } else {
                    // 所有请求都失败
                    logError('所有API路径尝试失败');
                    
                    // 获取当前显示的数据
                    const profileContainer = document.querySelector('.pro-profile');
                    const placeholderContainer = document.querySelector('.pro-placeholder');
                    
                    // 如果当前没有显示数据，显示错误信息
                    if (profileContainer.classList.contains('d-none')) {
                        placeholderContainer.classList.add('d-none');
                        profileContainer.classList.remove('d-none');
                        profileContainer.innerHTML = `
                            <div class="alert alert-warning">
                                <h5><i class="fas fa-exclamation-triangle me-2"></i>无法加载完整资料</h5>
                                <p>我们无法从服务器获取专业人士的详细资料。</p>
                                <p>您仍然可以与该专业人士联系或接受申请。</p>
                                <div class="mt-3">
                                    <button class="btn btn-primary" onclick="sendMessageToPro(${proId})">
                                        <i class="fas fa-comment-dots"></i> 发送消息
                                    </button>
                                    ${tabType === 'interestedPros' ? 
                                      `<button class="btn btn-success ms-2" onclick="acceptPro(${proId})">
                                          <i class="fas fa-check"></i> 接受申请
                                      </button>` : ''}
                                    <button class="btn btn-outline-secondary ms-2" onclick="loadProDetails('${proId}', '${tabType}')">
                                        <i class="fas fa-sync-alt me-1"></i>重试
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        // 如果已经显示了基本数据，添加一个小提示
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-warning mt-3';
                        alertDiv.innerHTML = `
                            <p class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>无法加载完整资料，显示的是基本信息</p>
                            <button class="btn btn-sm btn-outline-warning mt-2" onclick="loadProDetails('${proId}', '${tabType}')">
                                <i class="fas fa-sync-alt me-1"></i>重试加载
                            </button>
                        `;
                        
                        // 添加到资料卡片底部
                        const cardFooter = profileContainer.querySelector('.card-footer');
                        if (cardFooter) {
                            cardFooter.parentNode.insertBefore(alertDiv, cardFooter.nextSibling);
                        } else {
                            profileContainer.appendChild(alertDiv);
                        }
                    }
                }
            });
    }
    
    // 显示专业人士数据的函数
    function displayProData(data, tabType) {
        try {
            // 获取容器元素
            const profileContainer = document.querySelector('.pro-profile');
            const placeholderContainer = document.querySelector('.pro-placeholder');
            
            if (!profileContainer || !placeholderContainer) {
                logError('显示专业人士数据时找不到容器元素');
                return;
            }
            
            // 隐藏加载状态，显示资料
            placeholderContainer.classList.add('d-none');
            profileContainer.classList.remove('d-none');
            
            // 如果数据来自页面元素且正在加载中，添加加载指示器
            const loadingIndicator = data._fromPage ? 
                `<div class="position-absolute top-0 end-0 p-2">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                </div>` : '';
            
            // 创建专业人士档案HTML
            const profileHtml = `
                <div class="card mb-3 position-relative">
                    ${loadingIndicator}
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">${data.name || '未知专业人士'}</h5>
                    </div>
                    <div class="card-body">
                        ${data.profession ? `
                        <div class="row mb-3">
                            <div class="col-md-4 fw-bold">职业:</div>
                            <div class="col-md-8">${data.profession}</div>
                        </div>` : ''}
                        
                        ${data.skills && data.skills.length > 0 ? `
                        <div class="row mb-3">
                            <div class="col-md-4 fw-bold">技能:</div>
                            <div class="col-md-8">${Array.isArray(data.skills) ? data.skills.join(', ') : data.skills}</div>
                        </div>` : ''}
                        
                        ${data.contact ? `
                        <div class="row mb-3">
                            <div class="col-md-4 fw-bold">联系方式:</div>
                            <div class="col-md-8">${data.contact}</div>
                        </div>` : ''}
                        
                        <div class="row mb-3">
                            <div class="col-md-4 fw-bold">评分:</div>
                            <div class="col-md-8">${renderStars(data.rating || 0)}</div>
                        </div>
                        
                        ${data.completed_jobs !== undefined ? `
                        <div class="row mb-3">
                            <div class="col-md-4 fw-bold">已完成工作:</div>
                            <div class="col-md-8">
                                <div class="d-flex align-items-center">
                                    <span class="me-2">${data.completed_jobs} 个</span>
                                    <div class="progress flex-grow-1" style="height: 8px;">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             style="width: ${Math.min(data.completed_jobs * 5, 100)}%;" 
                                             aria-valuenow="${data.completed_jobs}" aria-valuemin="0" aria-valuemax="20">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>` : ''}
                        
                        ${data.distance !== undefined ? `
                        <div class="row mb-3">
                            <div class="col-md-4 fw-bold">距离:</div>
                            <div class="col-md-8">${data.distance} km</div>
                        </div>` : ''}
                        
                        ${data.match_score !== undefined ? `
                        <div class="row mb-3">
                            <div class="col-md-4 fw-bold">匹配度:</div>
                            <div class="col-md-8">
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: ${data.match_score}%;" 
                                        aria-valuenow="${data.match_score}" aria-valuemin="0" aria-valuemax="100">
                                        ${data.match_score}%
                                    </div>
                                </div>
                            </div>
                        </div>` : ''}
                        
                        ${data.description ? `
                        <div class="row mb-3">
                            <div class="col-md-4 fw-bold">简介:</div>
                            <div class="col-md-8">${data.description}</div>
                        </div>` : ''}
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-primary" onclick="sendMessageToPro(${data.id})">
                            <i class="fas fa-comment-dots"></i> 发送消息
                        </button>
                        ${tabType === 'interestedPros' ? 
                          `<button class="btn btn-success ms-2" onclick="acceptPro(${data.id})">
                              <i class="fas fa-check"></i> 接受申请
                          </button>` : ''}
                    </div>
                </div>
                
                ${data.portfolio ? 
                  `<div class="card mt-3">
                      <div class="card-header bg-primary text-white">
                          <h5 class="mb-0">作品集</h5>
                      </div>
                      <div class="card-body">
                          ${data.portfolio}
                      </div>
                  </div>` : ''}
            `;
            
            profileContainer.innerHTML = profileHtml;
        } catch (error) {
            logError('显示专业人士数据出错', error);
            if (profileContainer) {
                profileContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>显示专业人士资料时出错</h5>
                        <p>${error.message}</p>
                        <button class="btn btn-outline-danger btn-sm mt-2" onclick="loadProDetails('${proId}', '${tabType}')">
                            <i class="fas fa-sync-alt me-1"></i>重试
                        </button>
                    </div>
                `;
                profileContainer.classList.remove('d-none');
            }
            if (placeholderContainer) {
                placeholderContainer.classList.add('d-none');
            }
        }
    }
    
    // 标记对话为已读的函数
    function markConversationAsRead(otherUserId) {
        logDebug('标记对话为已读', {otherUserId, taskId});
        
        try {
            // 确保otherUserId是数字
            const numericOtherUserId = parseInt(otherUserId);
            if (isNaN(numericOtherUserId)) {
                logError('无效的用户ID', {otherUserId});
                return;
            }
            
            // 确保taskId是数字
            const numericTaskId = parseInt(taskId);
            if (isNaN(numericTaskId)) {
                logError('无效的任务ID', {taskId});
                return;
            }
            
            const url = `/message/api/messages/mark_read`;
            logDebug('构建标记已读API请求URL', {url, body: {task_id: numericTaskId, other_user_id: numericOtherUserId}});
            
            // 使用fetchWithCsrf函数来自动处理CSRF令牌
            fetchWithCsrf(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken  // 显式添加CSRF令牌
                },
                body: JSON.stringify({
                    task_id: numericTaskId,
                    other_user_id: numericOtherUserId
                })
            })
            .then(response => {
                logDebug('标记已读响应', {status: response.status, ok: response.ok});
                if (!response.ok) {
                    return response.text().then(text => {
                        logError(`标记已读请求失败，状态码: ${response.status}，响应内容:`, text);
                        throw new Error(`请求失败，状态码: ${response.status}，响应内容: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                logDebug('标记已读成功', data);
                
                // 更新UI，移除未读标记
                const conversationId = `${Math.min(parseInt(currentUserId), parseInt(otherUserId))}_${Math.max(parseInt(currentUserId), parseInt(otherUserId))}`;
                const chatItem = document.querySelector(`.chat-item[data-conversation-id="${conversationId}"]`);
                if (chatItem) {
                    const badge = chatItem.querySelector('.badge');
                    if (badge) {
                        badge.remove();
                    }
                    
                    // 移除高亮背景
                    chatItem.classList.remove('bg-light');
                }
                
                // 更新未读消息数
                updateUnreadCount();
            })
            .catch(error => {
                logError('标记对话为已读失败', error);
            });
        } catch (error) {
            logError('标记对话为已读失败', error);
        }
    }
    
    // 更新未读消息数的函数
    function updateUnreadCount() {
        logDebug('更新未读消息数');
        fetchWithCsrf(`/message/api/users/me/unread_messages`)
            .then(response => {
                logDebug('获取未读消息数响应', {status: response.status, ok: response.ok});
                if (!response.ok) {
                    throw new Error(`请求失败，状态码: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                logDebug('未读消息数', data);
                const unreadCount = data.unread_count;
                
                // 更新导航栏中的未读消息数
                const navBadge = document.querySelector('#nav-messages-badge');
                if (navBadge) {
                    if (unreadCount > 0) {
                        navBadge.textContent = unreadCount;
                        navBadge.classList.remove('d-none');
                    } else {
                        navBadge.classList.add('d-none');
                    }
                }
                
                // 更新聊天标签中的未读消息数
                const chatBadge = document.querySelector('#chat-tab-badge');
                if (chatBadge) {
                    if (unreadCount > 0) {
                        chatBadge.textContent = unreadCount;
                        chatBadge.classList.remove('d-none');
                    } else {
                        chatBadge.classList.add('d-none');
                    }
                }
            })
            .catch(error => {
                logError('更新未读消息数失败', error);
            });
    }
    
    // 发送消息的函数
    function sendMessage() {
        try {
            const messageInput = document.getElementById('message-input');
            if (!messageInput) {
                logError('发送消息失败', {error: '找不到消息输入框'});
                return;
            }
            
            const message = messageInput.value.trim();
            // 从发送按钮的data属性获取当前活跃对话ID
            const sendButton = document.getElementById('send-message-btn');
            const conversationId = sendButton.getAttribute('data-conversation-id') || 
                                  document.querySelector('.chat-item.active-chat')?.dataset.conversationId;
            
            logDebug('发送消息', {message, conversationId, taskId});
            
            if (!message) {
                logError('发送消息失败', {error: '消息不能为空'});
                return;
            }
            
            if (!conversationId) {
                logError('发送消息失败', {error: '未选择对话'});
                alert('请先选择一个对话');
                return;
            }
            
            // 解析对话ID，获取用户ID
            const userIds = conversationId.split('_');
            if (userIds.length !== 2) {
                logError('无效的对话ID格式', {conversationId});
                return;
            }
            
            const otherUserId = userIds[0] === currentUserId ? userIds[1] : userIds[0];
            logDebug('解析对话ID', {userIds, currentUserId, otherUserId});
            
            // 禁用输入框，防止重复发送
            messageInput.disabled = true;
            
            // 使用fetchWithCsrf函数发送请求
            fetchWithCsrf(`/message/api/messages/send`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    recipient_id: otherUserId,
                    content: message,
                    task_id: taskId
                })
            })
            .then(response => {
                logDebug('发送消息响应', {status: response.status, ok: response.ok});
                if (!response.ok) {
                    throw new Error(`请求失败，状态码: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                logDebug('发送消息成功', data);
                
                // 清空输入框
                messageInput.value = '';
                
                // 启用输入框
                messageInput.disabled = false;
                messageInput.focus();
                
                // 重新加载对话
                loadConversation(conversationId);
            })
            .catch(error => {
                logError('发送消息失败', error);
                
                // 启用输入框
                messageInput.disabled = false;
            });
        } catch (error) {
            logError('发送消息函数出错', error);
            
            // 确保输入框始终可用
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.disabled = false;
            }
        }
    }
    
    // 向专业人士发送消息的函数
    function sendMessageToPro(proId) {
        logDebug('向专业人士发送消息', {proId, taskId});
        
        // 构建对话ID
        const conversationId = `${Math.min(parseInt(currentUserId), parseInt(proId))}_${Math.max(parseInt(currentUserId), parseInt(proId))}`;
        logDebug('构建对话ID', {conversationId, currentUserId, proId});
        
        // 切换到聊天区域
        document.getElementById('chat-area-container').classList.remove('d-none');
        document.getElementById('pro-details-area').classList.add('d-none');
        document.getElementById('content-area-title').textContent = '聊天详情';
        document.getElementById('back-to-chat').style.display = 'none';
        
        // 高亮选中的聊天
        document.querySelectorAll('.chat-item').forEach(i => i.classList.remove('active-chat'));
        const chatItem = document.querySelector(`.chat-item[data-conversation-id="${conversationId}"]`);
        if (chatItem) {
            chatItem.classList.add('active-chat');
            
            // 更新未读消息徽章
            const badge = chatItem.querySelector('.badge');
            if (badge) {
                badge.classList.add('d-none');
            }
        } else {
            logDebug('未找到匹配的聊天项', {conversationId});
        }
        
        // 加载对话
        loadConversation(conversationId);
        
        // 刷新聊天列表
        refreshChatList();
    }
    
    // 接受专业人士申请的函数
    function acceptPro(proId) {
        logDebug('接受专业人士申请', {proId, taskId});
        
        // 创建URL
        const url = `/task/api/tasks/${taskId}/accept_pro/${proId}`;
        logDebug('构建接受专业人士申请API请求URL', {url});
        
        // 显示加载状态
        const acceptBtn = document.querySelector(`.btn-success[onclick="acceptPro(${proId})"]`);
        if (acceptBtn) {
            const originalText = acceptBtn.innerHTML;
            acceptBtn.disabled = true;
            acceptBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';
            
            // 恢复按钮状态的函数
            const restoreButton = () => {
                acceptBtn.disabled = false;
                acceptBtn.innerHTML = originalText;
            };
            
            fetchWithCsrf(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                logDebug('接受申请响应', {status: response.status, ok: response.ok});
                if (!response.ok) {
                    return response.text().then(text => {
                        logError('接受申请失败', {status: response.status, text});
                        throw new Error(`请求失败，状态码: ${response.status}, 错误信息: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                logDebug('接受申请成功', data);
                alert('已成功接受该专业人士的申请！');
                
                // 刷新页面以更新状态
                window.location.reload();
            })
            .catch(error => {
                logError('接受专业人士申请失败', error);
                alert(`接受申请失败: ${error.message}`);
                restoreButton();
                
                // 尝试备用API路径
                const backupUrl = `/api/tasks/${taskId}/accept_pro/${proId}`;
                logDebug('尝试备用API路径', {backupUrl});
                
                fetchWithCsrf(backupUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`备用请求失败，状态码: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    logDebug('通过备用API路径接受申请成功', data);
                    alert('已成功接受该专业人士的申请！');
                    
                    // 刷新页面以更新状态
                    window.location.reload();
                })
                .catch(backupError => {
                    logError('备用API路径也失败', backupError);
                    // 已经显示过错误提示，不再重复
                });
            });
        } else {
            logDebug('未找到接受按钮元素', {proId});
            // 如果找不到按钮，直接发送请求
            fetchWithCsrf(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                logDebug('接受申请响应', {status: response.status, ok: response.ok});
                if (!response.ok) {
                    return response.text().then(text => {
                        logError('接受申请失败', {status: response.status, text});
                        throw new Error(`请求失败，状态码: ${response.status}, 错误信息: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                logDebug('接受申请成功', data);
                alert('已成功接受该专业人士的申请！');
                
                // 刷新页面以更新状态
                window.location.reload();
            })
            .catch(error => {
                logError('接受专业人士申请失败', error);
                alert(`接受申请失败: ${error.message}`);
                
                // 尝试备用API路径
                const backupUrl = `/api/tasks/${taskId}/accept_pro/${proId}`;
                logDebug('尝试备用API路径', {backupUrl});
                
                fetchWithCsrf(backupUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`备用请求失败，状态码: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    logDebug('通过备用API路径接受申请成功', data);
                    alert('已成功接受该专业人士的申请！');
                    
                    // 刷新页面以更新状态
                    window.location.reload();
                })
                .catch(backupError => {
                    logError('备用API路径也失败', backupError);
                    // 已经显示过错误提示，不再重复
                });
            });
        }
    }
    
    // 刷新聊天列表的函数
    function refreshChatList() {
        logDebug('刷新聊天列表');
        
        fetchWithCsrf(`/task/api/tasks/${taskId}/conversations`)
            .then(response => {
                logDebug('获取聊天列表响应', {status: response.status, ok: response.ok});
                if (!response.ok) {
                    throw new Error(`请求失败，状态码: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                logDebug('获取聊天列表成功', {
                    conversationsCount: data.conversations.length,
                    conversations: data.conversations.map(c => ({
                        id: c.id,
                        other_user: {
                            id: c.other_user.id,
                            name: c.other_user.name
                        },
                        unread_count: c.unread_count,
                        last_message_preview: c.last_message_preview
                    }))
                });
                
                // 更新聊天列表
                const chatsContainer = document.querySelector('.chats-list');
                if (chatsContainer) {
                    logDebug('找到聊天列表容器', {
                        containerHTML: chatsContainer.outerHTML.substring(0, 100) + '...'
                    });
                    
                    // 保存当前活跃的对话ID
                    const activeConversationId = document.querySelector('.chat-item.active-chat')?.dataset.conversationId;
                    
                    chatsContainer.innerHTML = '';
                    
                    if (data.conversations.length === 0) {
                        chatsContainer.innerHTML = `
                            <div class="text-center p-3">
                                <p class="text-muted mb-0">您的任务尚未收到任何对话</p>
                            </div>
                        `;
                        logDebug('没有对话可显示');
                        return;
                    }
                    
                    data.conversations.forEach(conv => {
                        const unreadBadge = conv.unread_count > 0 ? 
                            `<span class="badge bg-danger rounded-pill mt-1">${conv.unread_count}</span>` : '';
                        
                        // 检查是否是当前活跃的对话
                        const isActive = conv.id === activeConversationId;
                        
                        logDebug('创建聊天项', {
                            conversation_id: conv.id,
                            other_user: conv.other_user.name,
                            unread_count: conv.unread_count,
                            isActive: isActive
                        });
                        
                        const chatItemHtml = `
                            <div class="chat-item p-3 border-bottom ${conv.unread_count > 0 ? 'bg-light' : ''} ${isActive ? 'active-chat' : ''}" data-conversation-id="${conv.id}">
                                <div class="d-flex align-items-center position-relative">
                                    <img src="${conv.other_user.avatar}" alt="${conv.other_user.name}" class="rounded-circle" width="40">
                                    <div class="ms-3 flex-grow-1">
                                        <h6 class="mb-1">${conv.other_user.name}</h6>
                                        <p class="text-muted mb-0 text-truncate" style="max-width: 140px;">${conv.last_message_preview}</p>
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted d-block">${formatDateTime(conv.last_message_time)}</small>
                                        ${unreadBadge}
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        chatsContainer.insertAdjacentHTML('beforeend', chatItemHtml);
                    });
                    
                    // 添加点击事件处理
                    const chatItems = document.querySelectorAll('.chat-item');
                    logDebug('添加点击事件到聊天项', {
                        chatItemsCount: chatItems.length
                    });
                    
                    chatItems.forEach(item => {
                        item.addEventListener('click', function() {
                            const conversationId = this.dataset.conversationId;
                            logDebug('点击刷新后的聊天项', {
                                conversationId: conversationId,
                                element: this.outerHTML
                            });
                            
                            // 移除所有聊天项的活动状态
                            document.querySelectorAll('.chat-item').forEach(el => {
                                el.classList.remove('active-chat');
                                logDebug('移除活动状态', {element: el.outerHTML});
                            });
                            
                            // 添加活动状态到当前项
                            this.classList.add('active-chat');
                            logDebug('添加活动状态后', {
                                hasActiveClass: this.classList.contains('active-chat')
                            });
                            
                            // 显示聊天区域，隐藏专业人士详情区域
                            document.getElementById('chat-area-container').classList.remove('d-none');
                            document.getElementById('pro-details-area').classList.add('d-none');
                            document.getElementById('content-area-title').textContent = '聊天详情';
                            document.getElementById('back-to-chat').style.display = 'none';
                            
                            // 加载对话详情
                            loadConversation(conversationId);
                            
                            // 检查聊天区域元素
                            const chatPlaceholder = document.querySelector('.chat-placeholder');
                            const chatMessages = document.querySelector('.chat-messages');
                            const chatInputArea = document.querySelector('.chat-input-area');
                            
                            logDebug('聊天区域元素', {
                                chatPlaceholder: chatPlaceholder ? true : false,
                                chatMessages: chatMessages ? true : false,
                                chatInputArea: chatInputArea ? true : false
                            });
                            
                            // 显示对话区域
                            if (chatPlaceholder) chatPlaceholder.classList.add('d-none');
                            if (chatMessages) chatMessages.classList.remove('d-none');
                            if (chatInputArea) chatInputArea.classList.remove('d-none');
                            
                            // 设置当前活跃对话ID到发送按钮的data属性
                            document.getElementById('send-message-btn').setAttribute('data-conversation-id', conversationId);
                        });
                    });
                    
                    // 如果有活跃对话，确保发送按钮有正确的对话ID
                    if (activeConversationId) {
                        document.getElementById('send-message-btn').setAttribute('data-conversation-id', activeConversationId);
                    }
                } else {
                    logError('找不到聊天列表容器', {selector: '.chats-list'});
                }
            })
            .catch(error => {
                logError('刷新聊天列表失败', error);
            });
    }
    
    // 格式化日期时间的函数
    function formatDateTime(dateTimeString) {
        try {
            const date = new Date(dateTimeString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (error) {
            logError('格式化日期时间出错', error);
            return dateTimeString;
        }
    }
    
    // 渲染星级评分的函数
    function renderStars(rating) {
        try {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
            
            let starsHtml = '';
            
            // 添加满星
            for (let i = 0; i < fullStars; i++) {
                starsHtml += '<i class="fas fa-star text-warning"></i>';
            }
            
            // 添加半星
            if (halfStar) {
                starsHtml += '<i class="fas fa-star-half-alt text-warning"></i>';
            }
            
            // 添加空星
            for (let i = 0; i < emptyStars; i++) {
                starsHtml += '<i class="far fa-star text-warning"></i>';
            }
            
            return `<div class="stars">${starsHtml} <span class="ms-2">${rating.toFixed(1)}</span></div>`;
        } catch (error) {
            logError('渲染星级评分出错', error);
            return `${rating || 0}`;
        }
    }
    
    // 绑定发送消息按钮点击事件
    const sendMessageBtn = document.getElementById('send-message-btn');
    if (sendMessageBtn) {
        sendMessageBtn.addEventListener('click', sendMessage);
    } else {
        logDebug('未找到发送消息按钮元素');
    }
    
    // 绑定消息输入框回车键事件
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    } else {
        logDebug('未找到消息输入框元素');
    }
    
    // 绑定聊天表单提交事件
    const chatForm = document.getElementById('chat-form');
    if (chatForm) {
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            sendMessage();
        });
    } else {
        logDebug('未找到聊天表单元素');
    }
    
    // 页面加载完成后自动刷新聊天列表
    window.addEventListener('load', function() {
        refreshCsrfToken();
        refreshChatList();
        updateUnreadCount();
        
        // 预加载专业人士数据
        preloadProfessionalsData();
        
        // 重新绑定发送按钮事件，确保在DOM更新后仍然有效
        document.getElementById('send-message-btn')?.addEventListener('click', sendMessage);
        
        // 确保输入框可用
        const messageInput = document.getElementById('message-input');
        if (messageInput) {
            messageInput.disabled = false;
        }
        
        // 添加CSS样式以确保聊天区域正确显示
        const style = document.createElement('style');
        style.textContent = `
            .message-outgoing {
                display: flex;
                justify-content: flex-end;
            }
            .message-incoming {
                display: flex;
                justify-content: flex-start;
            }
            .message-content {
                max-width: 70%; /* 从50%调整到70%，以便更好地容纳长文本 */
                word-break: break-word;
            }
            .chat-messages {
                overflow-y: auto;
                display: block !important;
            }
            .chat-input-area {
                display: block !important;
            }
            
            /* 添加专业人士资料卡片的过渡效果 */
            .pro-profile {
                transition: opacity 0.3s ease;
            }
            
            /* 添加加载状态的动画 */
            .loading-pulse {
                animation: pulse 1.5s infinite ease-in-out;
            }
            
            @keyframes pulse {
                0% { opacity: 0.6; }
                50% { opacity: 1; }
                100% { opacity: 0.6; }
            }
        `;
        document.head.appendChild(style);
    });
    
    // 预加载专业人士数据的函数
    function preloadProfessionalsData() {
        logDebug('开始预加载专业人士数据');
        
        // 获取所有专业人士项
        const proItems = document.querySelectorAll('.pro-item');
        if (!proItems || proItems.length === 0) {
            logDebug('没有找到专业人士项，跳过预加载');
            return;
        }
        
        // 创建一个延迟队列，避免同时发送太多请求
        const queue = [];
        proItems.forEach(item => {
            const proId = item.getAttribute('data-pro-id');
            const tabType = item.getAttribute('data-tab-id');
            
            if (proId && tabType) {
                queue.push({ proId, tabType });
            }
        });
        
        // 如果队列为空，直接返回
        if (queue.length === 0) {
            logDebug('预加载队列为空');
            return;
        }
        
        logDebug(`预加载队列中有 ${queue.length} 个专业人士数据`);
        
        // 使用交错延迟加载数据
        let index = 0;
        function processNext() {
            if (index >= queue.length) {
                logDebug('所有专业人士数据预加载完成');
                return;
            }
            
            const { proId, tabType } = queue[index++];
            const cacheKey = `pro_${proId}_${tabType}`;
            
            // 如果已经有缓存，跳过
            if (sessionStorage.getItem(cacheKey)) {
                logDebug(`专业人士 ${proId} 数据已缓存，跳过预加载`);
                processNext();
                return;
            }
            
            // 先从页面提取基本数据
            const proData = extractProDataFromPage(proId, tabType);
            if (proData) {
                try {
                    // 缓存基本数据
                    sessionStorage.setItem(cacheKey, JSON.stringify(proData));
                    logDebug(`专业人士 ${proId} 基本数据已缓存`);
                } catch (e) {
                    logError(`缓存专业人士 ${proId} 基本数据失败`, e);
                }
            }
            
            // 在后台获取完整数据
            setTimeout(() => {
                // 使用低优先级获取完整数据
                fetchProDataInBackground(proId, tabType, cacheKey);
                // 处理下一个
                processNext();
            }, 500); // 每500毫秒处理一个，避免同时发送太多请求
        }
        
        // 开始处理队列
        processNext();
    }
    
    // 在后台获取专业人士数据的函数
    function fetchProDataInBackground(proId, tabType, cacheKey) {
        logDebug(`在后台获取专业人士 ${proId} 数据`);
        
        // 尝试不同的API路径
        const urls = [
            `/task/api/professionals/${proId}?task_id=${taskId}`,
            `/api/professionals/${proId}?task_id=${taskId}`,
            `/api/tasks/${taskId}/professionals/${proId}`
        ];
        
        // 使用Promise.race尝试所有URL，取第一个成功的结果
        const fetchPromises = urls.map(url => {
            return new Promise((resolve, reject) => {
                fetchWithCsrf(url)
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(`请求失败，状态码: ${response.status}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        resolve(data);
                    })
                    .catch(error => {
                        reject(error);
                    });
            });
        });
        
        Promise.race(fetchPromises)
            .then(data => {
                // 缓存数据
                try {
                    sessionStorage.setItem(cacheKey, JSON.stringify(data));
                    logDebug(`专业人士 ${proId} 完整数据已缓存`);
                } catch (e) {
                    logError(`缓存专业人士 ${proId} 完整数据失败`, e);
                }
            })
            .catch(error => {
                logDebug(`在后台获取专业人士 ${proId} 数据失败，将在用户点击时重试`);
            });
    }
</script>

<style>
    /* 消息样式 */
    .message {
        clear: both;
        margin-bottom: 15px;
        transition: all 0.2s ease;
    }
    
    .message-outgoing {
        text-align: right;
    }
    
    .message-incoming {
        text-align: left;
    }
    
    .message-content {
        display: inline-block;
        padding: 12px 16px;
        max-width: 200%; /* 从50%调整到70%，以便更好地容纳长文本 */
        min-width: 60px; /* 添加最小宽度，避免短消息气泡过窄 */
        border-radius: 18px;
        word-wrap: break-word;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }
    
    .message-outgoing .message-content {
        background-color: #0084ff;
        color: white;
        border-bottom-right-radius: 6px;
        margin-right: 2px;
    }
    
    .message-incoming .message-content {
        background-color: #f0f2f5;
        color: #1c1e21;
        border-bottom-left-radius: 6px;
        margin-left: 2px;
    }
    
    .message-time {
        font-size: 0.7rem;
        margin-top: 5px;
        opacity: 0.8;
    }
    
    /* 头像样式 */
    .avatar-sm {
        width: 30px;
        height: 30px;
        object-fit: cover;
        border-radius: 50%;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    /* 消息容器样式调整 */
    .chat-messages {
        padding: 15px;
        background-color: #ffffff;
        scroll-behavior: smooth; /* 添加平滑滚动效果 */
    }
    
    /* 悬停效果 */
    .message:hover .message-time {
        opacity: 1;
    }
    
    /* 响应式调整 */
    @media (max-width: 768px) {
        .message-content {
            max-width: 80%; /* 在小屏幕上增加气泡最大宽度 */
            padding: 10px 14px;
        }
        
        .chat-messages {
            padding: 10px;
            height: calc(100vh - 350px) !important; /* 调整高度 */
        }
    }
    
    @media (max-width: 576px) {
        .message-content {
            max-width: 90%; /* 在更小的屏幕上进一步增加气泡宽度 */
            padding: 8px 12px;
        }
    }
    
    /* 消息输入区域样式调整 */
    .chat-input-area {
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        background-color: #f8f9fa;
        padding: 12px !important;
    }
    
    /* 美化输入框 */
    #message-input {
        border-radius: 20px;
        padding-left: 15px;
        transition: all 0.2s ease;
    }
    
    #message-input:focus {
        box-shadow: 0 0 0 0.2rem rgba(0, 132, 255, 0.15);
    }
    
    /* 美化发送按钮 */
    #send-message-btn {
        border-radius: 50%;
        width: 38px;
        height: 38px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 8px;
    }
</style>
{% endblock %}
{% endblock %}
