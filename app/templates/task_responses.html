{% extends "base.html" %}

{% block title %}{{ task.title }} - 对你的某任务的回应{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- 任务标题和基本信息 -->
        <div class="col-12 mb-4">
            <div class="card shadow-sm border-0 rounded-lg">
                <div class="card-header bg-gradient-primary text-dark py-3">
                    <h1 class="card-title h3 mb-0">{{ task.title }}</h1>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-primary me-2">
                                <i class="fas fa-map-marker-alt me-1"></i>{{ task.location }}
                            </span>
                            <span class="badge bg-info me-2">
                                <i class="fas fa-calendar-alt me-1"></i>{{ task.created_at|datetimeformat }}
                            </span>
                        </div>
                        <div>
                            {% if task.status == 0 %}
                            <span class="badge bg-warning text-dark">
                                <i class="fas fa-hourglass-start me-1"></i>等待接单
                            </span>
                            {% elif task.status == 1 %}
                            <span class="badge bg-info">
                                <i class="fas fa-hourglass-half me-1"></i>等待执行
                            </span>
                            {% elif task.status == 2 %}
                            <span class="badge bg-primary">
                                <i class="fas fa-check-circle me-1"></i>任务完成
                            </span>
                            {% elif task.status == 3 %}
                            <span class="badge bg-success">
                                <i class="fas fa-money-bill-wave me-1"></i>付款完成
                            </span>
                            {% elif task.status == 4 %}
                            <span class="badge bg-danger">
                                <i class="fas fa-times-circle me-1"></i>已取消
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 左侧导航栏 -->
        <div class="col-md-3">
            <!-- 我的聊天 -->
            <div class="card shadow-sm border-0 rounded-lg mb-3">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-comments me-2"></i>我的聊天
                        <span class="badge bg-danger float-end">{{ unread_messages_count }}</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="chats-list" style="max-height: 300px; overflow-y: auto;">
                        {% if conversations %}
                            {% for conv in conversations %}
                                <div class="chat-item p-3 border-bottom {% if conv.has_unread %}bg-light{% endif %}" data-conversation-id="{{ conv.id }}">
                                    <div class="d-flex align-items-center position-relative">
                                        <img src="{{ conv.pro_avatar }}" alt="{{ conv.pro_name }}" class="rounded-circle" width="40">
                                        <div class="ms-3 flex-grow-1">
                                            <h6 class="mb-1">{{ conv.pro_name }}</h6>
                                            <p class="text-muted mb-0 text-truncate" style="max-width: 140px;">{{ conv.last_message_preview }}</p>
                                        </div>
                                        <div class="text-end">
                                            <small class="text-muted d-block">{{ conv.last_message_time | datetimeformat }}</small>
                                            {% if conv.has_unread %}
                                                <span class="badge bg-danger rounded-pill mt-1">{{ conv.unread_count }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center p-3">
                                <p class="text-muted mb-0">您的任务尚未收到任何对话</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 感兴趣的专业人士 -->
            <div class="card shadow-sm border-0 rounded-lg mb-3">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-tie me-2"></i>感兴趣的专业人士
                        <span class="badge bg-primary float-end">{{ interested_pros_count }}</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="pros-list interested-pros-list" style="max-height: 300px; overflow-y: auto;">
                        {% if interested_pros %}
                            {% for pro in interested_pros %}
                            <div class="pro-item p-3 border-bottom" data-pro-id="{{ pro.id }}" data-tab-id="interestedPros">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <img src="{{ pro.avatar }}" alt="{{ pro.name }}的头像" 
                                            class="rounded-circle" width="40">
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0">{{ pro.name }}</h6>
                                        <div class="text-muted small">
                                            <i class="fas fa-star text-warning"></i> {{ pro.rating }}
                                            <span class="mx-1">|</span>
                                            <i class="fas fa-briefcase"></i> {{ pro.completed_jobs }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center p-3">
                                <p class="text-muted mb-0">暂时没有专业人士对此任务感兴趣</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 符合要求的专业人士 -->
            <div class="card shadow-sm border-0 rounded-lg mb-3">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-check-circle me-2"></i>符合你要求的专业人士
                        <span class="badge bg-success float-end">{{ matching_pros_count }}</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="pros-list matching-pros-list" style="max-height: 300px; overflow-y: auto;">
                        {% if matching_pros %}
                            {% for pro in matching_pros %}
                            <div class="pro-item p-3 border-bottom" data-pro-id="{{ pro.id }}" data-tab-id="matchingPros">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <img src="{{ pro.avatar }}" alt="{{ pro.name }}的头像" 
                                            class="rounded-circle" width="40">
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0">{{ pro.name }}</h6>
                                        <div class="text-muted small">
                                            <i class="fas fa-star text-warning"></i> {{ pro.rating }}
                                            <span class="mx-1">|</span>
                                            <i class="fas fa-map-marker-alt"></i> {{ pro.distance }}km
                                        </div>
                                        <div class="mt-1">
                                            <span class="badge bg-success">匹配度: {{ pro.match_score }}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center p-3">
                                <p class="text-muted mb-0">我们正在为您寻找符合要求的专业人士</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 工作详情入口 -->
            <div class="card shadow-sm border-0 rounded-lg">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>工作详情
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid">
                        <button class="btn btn-outline-primary" id="view-task-details">
                            <i class="fas fa-eye me-2"></i>查看完整工作详情
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧内容区域 -->
        <div class="col-md-9">
            <div class="card shadow-sm border-0 rounded-lg">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0" id="content-area-title">聊天详情</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="back-to-chat" style="display:none;">
                            <i class="fas fa-arrow-left me-1"></i>返回聊天
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="content-section" id="chat-area">
                        <div class="row">
                            <!-- 聊天窗口 -->
                            <div class="col-12">
                                <div class="chat-window" id="chat-window">
                                    <div class="text-center p-5 chat-placeholder">
                                        <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                        <p>请从左侧选择一个对话开始聊天</p>
                                    </div>
                                    
                                    <div class="chat-messages d-none" style="height: 400px; overflow-y: auto;">
                                        <!-- 消息内容区 -->
                                    </div>
                                    
                                    <div class="chat-input-area d-none mt-3">
                                        <form id="chat-form">
                                            <div class="input-group">
                                                <textarea class="form-control" id="message-input" rows="2" 
                                                          placeholder="输入您的消息..."></textarea>
                                                <button class="btn btn-primary" type="submit">
                                                    <i class="fas fa-paper-plane"></i>
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="content-section d-none" id="pro-details-area">
                        <div class="pro-details">
                            <div class="text-center p-5 pro-placeholder">
                                <i class="fas fa-user-tie fa-3x text-muted mb-3"></i>
                                <p>正在加载专业人士资料...</p>
                            </div>
                            <div class="pro-profile d-none">
                                <!-- 专业人士资料 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 任务详情模态框 -->
<div class="modal fade" id="taskDetailsModal" tabindex="-1" aria-labelledby="taskDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskDetailsModalLabel">{{ task.title }} - 工作详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="task-info mb-4">
                    <h6 class="fw-bold">描述</h6>
                    <p>{{ task.description }}</p>
                </div>
                
                <div class="task-info mb-4">
                    <h6 class="fw-bold">基本信息</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-map-marker-alt text-primary"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <small class="text-muted">位置</small>
                                    <p class="mb-0">{{ task.location }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-calendar-alt text-primary"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <small class="text-muted">期望日期</small>
                                    <p class="mb-0">{{ task.deadline|datetimeformat }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-clock text-primary"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <small class="text-muted">发布时间</small>
                                    <p class="mb-0">{{ task.created_at|datetimeformat }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-tag text-primary"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <small class="text-muted">预算</small>
                                    <p class="mb-0">¥{{ task.budget }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if task.attachments %}
                <div class="task-info mb-4">
                    <h6 class="fw-bold">附件</h6>
                    <div class="row">
                        {% for attachment in task.attachments %}
                        <div class="col-md-3 mb-3">
                            <div class="card">
                                <img src="{{ attachment.url }}" class="card-img-top" alt="附件图片">
                                <div class="card-body p-2">
                                    <a href="{{ attachment.url }}" class="btn btn-sm btn-outline-primary w-100" download>
                                        <i class="fas fa-download me-1"></i>下载
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <a href="{{ url_for('task.edit_task', task_id=task.id) }}" class="btn btn-outline-primary">
                    <i class="fas fa-edit me-1"></i>编辑任务
                </a>
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#cancelTaskModal" data-bs-dismiss="modal">
                    <i class="fas fa-times-circle me-1"></i>取消任务
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 取消任务确认模态框 -->
<div class="modal fade" id="cancelTaskModal" tabindex="-1" aria-labelledby="cancelTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelTaskModalLabel">确认取消任务</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>您确定要取消此任务吗？此操作无法撤销。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <form action="{{ url_for('task.cancel_task', task_id=task.id) }}" method="post">
                    <button type="submit" class="btn btn-danger">确认取消</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
{{ super() }}
<script>
    // 存储当前任务ID和当前用户ID
    const taskId = "{{ task.id }}";
    const currentUserId = "{{ current_user.id }}";
    let csrfToken = "{{ csrf_token }}";
    
    // 添加全局错误处理
    window.addEventListener('error', function(event) {
        console.error('全局错误:', event.error.message);
        console.error('错误堆栈:', event.error.stack);
    });

    // 添加调试日志函数
    function logDebug(message, data) {
        console.log(`[DEBUG] ${message}`, data || '');
    }

    function logError(message, error) {
        console.error(`[ERROR] ${message}`, error || '');
        if (error && error.stack) {
            console.error(`[ERROR STACK] ${error.stack}`);
        }
    }
    
    // 获取最新的CSRF令牌
    function refreshCsrfToken() {
        logDebug('获取最新CSRF令牌');
        return fetch('/api/csrf-token')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`请求失败，状态码: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                csrfToken = data.csrf_token;
                logDebug('CSRF令牌已更新');
                return csrfToken;
            })
            .catch(error => {
                logError('获取CSRF令牌失败', error);
                return null;
            });
    }
    
    // 创建带有CSRF令牌的通用fetch包装函数
    async function fetchWithCsrf(url, options = {}) {
        try {
            // 确保options.headers存在
            options.headers = options.headers || {};
            
            // 如果是POST/PUT/DELETE等修改请求，需要CSRF令牌
            if (['POST', 'PUT', 'DELETE', 'PATCH'].includes(options.method)) {
                // 添加CSRF令牌到请求头
                options.headers['X-CSRFToken'] = csrfToken;
                options.credentials = 'same-origin';
                
                // 如果CSRF令牌为空或过期，先刷新令牌
                if (!csrfToken) {
                    csrfToken = await refreshCsrfToken();
                    options.headers['X-CSRFToken'] = csrfToken;
                }
            }
            
            // 发送请求
            const response = await fetch(url, options);
            
            // 检查是否需要刷新CSRF令牌（如果返回403和CSRF错误）
            if (response.status === 403) {
                const responseText = await response.text();
                if (responseText.includes('CSRF') || responseText.includes('csrf')) {
                    logDebug('CSRF令牌可能已过期，正在刷新');
                    await refreshCsrfToken();
                    
                    // 使用新令牌重试请求
                    options.headers['X-CSRFToken'] = csrfToken;
                    return fetch(url, options);
                }
            }
            
            return response;
        } catch (error) {
            logError('fetchWithCsrf请求出错', error);
            throw error;
        }
    }
    
    // 初始化日志
    logDebug('页面初始化', {taskId, currentUserId});
    
    // 处理聊天列表点击事件
    document.querySelectorAll('.chat-item').forEach(item => {
        item.addEventListener('click', function() {
            try {
                const conversationId = this.getAttribute('data-conversation-id');
                logDebug('点击对话项', {conversationId, taskId});
                
                // 显示聊天区域，隐藏其他区域
                document.getElementById('chat-area').classList.remove('d-none');
                document.getElementById('pro-details-area').classList.add('d-none');
                document.getElementById('content-area-title').textContent = '聊天详情';
                document.getElementById('back-to-chat').style.display = 'none';
                
                // 加载对话内容
                loadConversation(conversationId);
                
                // 高亮选中的聊天
                document.querySelectorAll('.chat-item').forEach(i => i.classList.remove('bg-primary', 'text-white'));
                this.classList.add('bg-primary', 'text-white');
                
                // 显示聊天窗口
                document.querySelector('.chat-placeholder').classList.add('d-none');
                document.querySelector('.chat-messages').classList.remove('d-none');
                document.querySelector('.chat-input-area').classList.remove('d-none');
            } catch (error) {
                logError('处理聊天项点击事件出错', error);
            }
        });
    });
    
    // 处理专业人士列表点击事件
    document.querySelectorAll('.pro-item').forEach(item => {
        item.addEventListener('click', function() {
            try {
                const proId = this.getAttribute('data-pro-id');
                const tabType = this.getAttribute('data-tab-id');
                logDebug('点击专业人士项', {proId, tabType});
                
                // 显示专业人士详情区域，隐藏其他区域
                document.getElementById('chat-area').classList.add('d-none');
                document.getElementById('pro-details-area').classList.remove('d-none');
                document.getElementById('content-area-title').textContent = '专业人士详情';
                document.getElementById('back-to-chat').style.display = 'block';
                
                // 加载专业人士详情
                loadProDetails(proId, tabType);
                
                // 高亮选中的专业人士
                document.querySelectorAll('.pro-item').forEach(i => 
                    i.classList.remove('bg-primary', 'text-white'));
                this.classList.add('bg-primary', 'text-white');
                
                // 显示专业人士详情
                document.querySelector('.pro-placeholder').classList.add('d-none');
                document.querySelector('.pro-profile').classList.remove('d-none');
            } catch (error) {
                logError('处理专业人士项点击事件出错', error);
            }
        });
    });
    
    // 返回聊天区域按钮
    document.getElementById('back-to-chat').addEventListener('click', function() {
        document.getElementById('chat-area').classList.remove('d-none');
        document.getElementById('pro-details-area').classList.add('d-none');
        document.getElementById('content-area-title').textContent = '聊天详情';
        this.style.display = 'none';
    });
    
    // 工作详情按钮
    document.getElementById('view-task-details').addEventListener('click', function() {
        const taskDetailsModal = new bootstrap.Modal(document.getElementById('taskDetailsModal'));
        taskDetailsModal.show();
    });
    
    // 加载对话内容的函数
    function loadConversation(conversationId) {
        logDebug('开始加载对话', {conversationId});
        const url = `/api/conversations/${conversationId}/messages?task_id=${taskId}`;
        const messagesContainer = document.querySelector('.chat-messages');
        
        // 显示加载状态
        messagesContainer.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">加载聊天记录中...</p></div>';
        
        // 发送AJAX请求
        logDebug('发送API请求', {url});
        fetchWithCsrf(url)
            .then(response => {
                logDebug('获取API响应', {status: response.status, ok: response.ok});
                if (!response.ok) {
                    throw new Error(`请求失败，状态码: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                logDebug('解析API响应数据', {messagesCount: data.messages.length, unreadCount: data.unread_count});
                
                // 清空容器
                messagesContainer.innerHTML = '';
                
                // 渲染消息
                data.messages.forEach((message, index) => {
                    try {
                        const isCurrentUser = message.sender_id === parseInt(currentUserId);
                        const messageHtml = `
                            <div class="message ${isCurrentUser ? 'message-outgoing' : 'message-incoming'} mb-3">
                                <div class="message-content ${isCurrentUser ? 'bg-primary text-white' : 'bg-light'} p-3 rounded">
                                    ${message.content}
                                    <div class="message-time small ${isCurrentUser ? 'text-light' : 'text-muted'} mt-1">
                                        ${formatDateTime(message.created_at)}
                                    </div>
                                </div>
                            </div>
                        `;
                        messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
                    } catch (error) {
                        logError(`渲染消息出错 (索引: ${index})`, error);
                    }
                });
                
                // 滚动到底部
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // 标记为已读
                if (data.unread_count > 0) {
                    markConversationAsRead(conversationId);
                }
            })
            .catch(error => {
                logError('加载对话失败', error);
                messagesContainer.innerHTML = `<div class="alert alert-danger">加载聊天记录失败: ${error.message}</div>`;
            });
    }
    
    // 加载专业人士详情的函数
    function loadProDetails(proId, tabType) {
        logDebug('开始加载专业人士详情', {proId, tabType});
        const url = `/api/professionals/${proId}`;
        const profileContainer = document.querySelector('.pro-profile');
        
        // 显示加载状态
        profileContainer.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">加载专业人士资料中...</p></div>';
        
        // 发送AJAX请求
        logDebug('发送API请求', {url});
        fetchWithCsrf(url)
            .then(response => {
                logDebug('获取API响应', {status: response.status, ok: response.ok});
                if (!response.ok) {
                    throw new Error(`请求失败，状态码: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                logDebug('解析专业人士数据', data);
                
                // 创建专业人士档案HTML
                const profileHtml = `
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">${data.name}</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-4 fw-bold">职业:</div>
                                <div class="col-md-8">${data.profession || '未提供'}</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4 fw-bold">技能:</div>
                                <div class="col-md-8">${data.skills ? data.skills.join(', ') : '未提供'}</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4 fw-bold">联系方式:</div>
                                <div class="col-md-8">${data.contact || '未提供'}</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4 fw-bold">评分:</div>
                                <div class="col-md-8">${renderStars(data.rating || 0)}</div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-primary" onclick="sendMessageToPro(${data.id})">
                                <i class="fas fa-comment-dots"></i> 发送消息
                            </button>
                            ${tabType === 'interestedPros' ? 
                              `<button class="btn btn-success ms-2" onclick="acceptPro(${data.id})">
                                  <i class="fas fa-check"></i> 接受申请
                              </button>` : ''}
                        </div>
                    </div>
                    
                    ${data.portfolio ? 
                      `<div class="card mt-3">
                          <div class="card-header bg-primary text-white">
                              <h5 class="mb-0">作品集</h5>
                          </div>
                          <div class="card-body">
                              ${data.portfolio}
                          </div>
                      </div>` : ''}
                `;
                
                profileContainer.innerHTML = profileHtml;
            })
            .catch(error => {
                logError('加载专业人士详情失败', error);
                profileContainer.innerHTML = `<div class="alert alert-danger">加载专业人士详情失败: ${error.message}</div>`;
            });
    }
    
    // 标记对话为已读的函数
    function markConversationAsRead(conversationId) {
        logDebug('标记对话为已读', {conversationId});
        const url = `/api/conversations/${conversationId}/read`;
        
        fetchWithCsrf(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            logDebug('标记已读响应', {status: response.status, ok: response.ok});
            if (!response.ok) {
                throw new Error(`请求失败，状态码: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            logDebug('标记已读成功', data);
            
            // 更新UI，移除未读标记
            const chatItem = document.querySelector(`.chat-item[data-conversation-id="${conversationId}"]`);
            if (chatItem) {
                const badge = chatItem.querySelector('.badge');
                if (badge) {
                    badge.remove();
                }
            }
            
            // 更新未读消息数
            updateUnreadCount();
        })
        .catch(error => {
            logError('标记对话为已读失败', error);
        });
    }
    
    // 更新未读消息数的函数
    function updateUnreadCount() {
        logDebug('更新未读消息数');
        fetchWithCsrf(`/api/users/me/unread_messages`)
            .then(response => {
                logDebug('获取未读消息数响应', {status: response.status, ok: response.ok});
                if (!response.ok) {
                    throw new Error(`请求失败，状态码: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                logDebug('未读消息数', data);
                const unreadCount = data.unread_count;
                
                // 更新导航栏中的未读消息数
                const navBadge = document.querySelector('#nav-messages-badge');
                if (navBadge) {
                    if (unreadCount > 0) {
                        navBadge.textContent = unreadCount;
                        navBadge.classList.remove('d-none');
                    } else {
                        navBadge.classList.add('d-none');
                    }
                }
                
                // 更新聊天标签中的未读消息数
                const chatBadge = document.querySelector('#chat-tab-badge');
                if (chatBadge) {
                    if (unreadCount > 0) {
                        chatBadge.textContent = unreadCount;
                        chatBadge.classList.remove('d-none');
                    } else {
                        chatBadge.classList.add('d-none');
                    }
                }
            })
            .catch(error => {
                logError('更新未读消息数失败', error);
            });
    }
    
    // 发送消息的函数
    function sendMessage() {
        try {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            const conversationId = document.querySelector('.chat-item.bg-primary')?.getAttribute('data-conversation-id');
            
            logDebug('发送消息', {message, conversationId, taskId});
            
            if (!message || !conversationId) {
                logError('发送消息失败', {error: '消息为空或未选择对话'});
                return;
            }
            
            // 发送AJAX请求
            fetchWithCsrf(`/api/conversations/${conversationId}/messages`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    content: message,
                    task_id: taskId
                })
            })
            .then(response => {
                logDebug('发送消息响应', {status: response.status, ok: response.ok});
                if (!response.ok) {
                    throw new Error(`请求失败，状态码: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                logDebug('发送消息成功', data);
                
                // 清空输入框
                messageInput.value = '';
                
                // 重新加载对话
                loadConversation(conversationId);
            })
            .catch(error => {
                logError('发送消息失败', error);
                alert(`发送消息失败: ${error.message}`);
            });
        } catch (error) {
            logError('发送消息函数出错', error);
        }
    }
    
    // 向专业人士发送消息的函数
    function sendMessageToPro(proId) {
        logDebug('向专业人士发送消息', {proId, taskId});
        
        // 创建或获取对话
        fetchWithCsrf(`/api/conversations/with_professional/${proId}?task_id=${taskId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            logDebug('创建对话响应', {status: response.status, ok: response.ok});
            if (!response.ok) {
                throw new Error(`请求失败，状态码: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            logDebug('创建对话成功', data);
            const conversationId = data.id;
            
            // 切换到聊天区域
            document.getElementById('chat-area').classList.remove('d-none');
            document.getElementById('pro-details-area').classList.add('d-none');
            document.getElementById('content-area-title').textContent = '聊天详情';
            document.getElementById('back-to-chat').style.display = 'none';
            
            // 高亮选中的聊天
            document.querySelectorAll('.chat-item').forEach(i => i.classList.remove('bg-primary', 'text-white'));
            const chatItem = document.querySelector(`.chat-item[data-conversation-id="${conversationId}"]`);
            if (chatItem) {
                chatItem.classList.add('bg-primary', 'text-white');
            }
            
            // 加载对话
            loadConversation(conversationId);
            
            // 刷新聊天列表
            refreshChatList();
        })
        .catch(error => {
            logError('向专业人士发送消息失败', error);
            alert(`创建对话失败: ${error.message}`);
        });
    }
    
    // 接受专业人士申请的函数
    function acceptPro(proId) {
        logDebug('接受专业人士申请', {proId, taskId});
        
        fetchWithCsrf(`/api/tasks/${taskId}/accept_pro/${proId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            logDebug('接受申请响应', {status: response.status, ok: response.ok});
            if (!response.ok) {
                throw new Error(`请求失败，状态码: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            logDebug('接受申请成功', data);
            alert('已成功接受该专业人士的申请！');
            
            // 刷新页面以更新状态
            window.location.reload();
        })
        .catch(error => {
            logError('接受专业人士申请失败', error);
            alert(`接受申请失败: ${error.message}`);
        });
    }
    
    // 刷新聊天列表的函数
    function refreshChatList() {
        logDebug('刷新聊天列表');
        
        fetchWithCsrf(`/api/tasks/${taskId}/conversations`)
            .then(response => {
                logDebug('获取聊天列表响应', {status: response.status, ok: response.ok});
                if (!response.ok) {
                    throw new Error(`请求失败，状态码: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                logDebug('获取聊天列表成功', data);
                
                // 更新聊天列表
                const chatsContainer = document.querySelector('#my-chats-content .list-group');
                if (chatsContainer) {
                    chatsContainer.innerHTML = '';
                    
                    data.conversations.forEach(conv => {
                        const unreadBadge = conv.unread_count > 0 ? 
                            `<span class="badge bg-danger rounded-pill">${conv.unread_count}</span>` : '';
                        
                        const chatItemHtml = `
                            <div class="list-group-item list-group-item-action chat-item" 
                                 data-conversation-id="${conv.id}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${conv.other_user.name}</strong>
                                        <p class="mb-0 small text-muted">${formatDateTime(conv.last_message_time)}</p>
                                    </div>
                                    ${unreadBadge}
                                </div>
                            </div>
                        `;
                        
                        chatsContainer.insertAdjacentHTML('beforeend', chatItemHtml);
                    });
                    
                    // 重新绑定事件
                    document.querySelectorAll('.chat-item').forEach(item => {
                        item.addEventListener('click', function() {
                            try {
                                const conversationId = this.getAttribute('data-conversation-id');
                                logDebug('点击对话项', {conversationId, taskId});
                                
                                // 显示聊天区域，隐藏其他区域
                                document.getElementById('chat-area').classList.remove('d-none');
                                document.getElementById('pro-details-area').classList.add('d-none');
                                document.getElementById('content-area-title').textContent = '聊天详情';
                                document.getElementById('back-to-chat').style.display = 'none';
                                
                                // 加载对话内容
                                loadConversation(conversationId);
                                
                                // 高亮选中的聊天
                                document.querySelectorAll('.chat-item').forEach(i => i.classList.remove('bg-primary', 'text-white'));
                                this.classList.add('bg-primary', 'text-white');
                                
                                // 显示聊天窗口
                                document.querySelector('.chat-placeholder').classList.add('d-none');
                                document.querySelector('.chat-messages').classList.remove('d-none');
                                document.querySelector('.chat-input-area').classList.remove('d-none');
                            } catch (error) {
                                logError('处理聊天项点击事件出错', error);
                            }
                        });
                    });
                }
            })
            .catch(error => {
                logError('刷新聊天列表失败', error);
            });
    }
    
    // 格式化日期时间的函数
    function formatDateTime(dateTimeString) {
        try {
            const date = new Date(dateTimeString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (error) {
            logError('格式化日期时间出错', error);
            return dateTimeString;
        }
    }
    
    // 渲染星级评分的函数
    function renderStars(rating) {
        try {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
            
            let starsHtml = '';
            
            // 添加满星
            for (let i = 0; i < fullStars; i++) {
                starsHtml += '<i class="fas fa-star text-warning"></i>';
            }
            
            // 添加半星
            if (halfStar) {
                starsHtml += '<i class="fas fa-star-half-alt text-warning"></i>';
            }
            
            // 添加空星
            for (let i = 0; i < emptyStars; i++) {
                starsHtml += '<i class="far fa-star text-warning"></i>';
            }
            
            return `<div class="stars">${starsHtml} <span class="ms-2">${rating.toFixed(1)}</span></div>`;
        } catch (error) {
            logError('渲染星级评分出错', error);
            return `${rating || 0}`;
        }
    }
    
    // 绑定发送消息按钮点击事件
    document.getElementById('send-message-btn').addEventListener('click', sendMessage);
    
    // 绑定消息输入框回车键事件
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // 页面加载完成后自动刷新聊天列表
    window.addEventListener('load', function() {
        refreshCsrfToken();
        refreshChatList();
        updateUnreadCount();
    });
</script>
{% endblock %}
{% endblock %}
