{% extends "base.html" %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- 进度指示器 -->
            <div class="progress-container mb-4">
                <div class="progress" style="height: 4px;">
                    <div class="progress-bar bg-primary" role="progressbar" id="form-progress-bar" style="width: 20%;" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <div class="step active" data-step="1">
                        <div class="step-circle">1</div>
                        <div class="step-text">服务类别</div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-circle">2</div>
                        <div class="step-text">服务详情</div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-circle">3</div>
                        <div class="step-text">时间和预算</div>
                    </div>
                    <div class="step" data-step="4">
                        <div class="step-circle">4</div>
                        <div class="step-text">任务描述</div>
                    </div>
                    <div class="step" data-step="5">
                        <div class="step-circle">5</div>
                        <div class="step-text">确认发布</div>
                    </div>
                </div>
            </div>

            <!-- 表单卡片 -->
            <div class="card shadow-sm border-0 rounded-3">
                <div class="card-body p-4">
                    <form method="POST" class="needs-validation" id="task-form" enctype="multipart/form-data" novalidate>
                        {{ form.hidden_tag() }}
                        
                        <!-- 步骤1：服务类别 -->
                        <div class="form-step" id="step-1">
                            <h3 class="card-title mb-4">选择服务类别</h3>
                            
                            {% if preselect_category %}
                            <div class="alert alert-info mb-4">
                                <i class="fas fa-info-circle me-2"></i>
                                根据您的搜索"{{ preselect_category }}"，我们已为您预选了最匹配的服务类别。
                            </div>
                            {% endif %}
                            
                            <div class="mb-4">
                                <label class="form-label fw-bold">您需要什么类型的服务？</label>
                                <div class="service-categories">
                                    <select class="form-select form-select-lg" id="service_category" name="service_category" required>
                                        {% for value, label in form.service_category.choices %}
                                            {% if '.' not in value %}
                                                {% if value != '' %}
                                                    <option disabled class="fw-bold bg-light">{{ label }}</option>
                                                {% else %}
                                                    <option value="">{{ label }}</option>
                                                {% endif %}
                                            {% else %}
                                                <option value="{{ value }}"{% if form.service_category.data == value %} selected{% endif %}>
                                                    {{ label }}
                                                </option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                    <div class="invalid-feedback">请选择服务类别</div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-primary btn-lg px-4 next-step">下一步</button>
                            </div>
                        </div>
                        
                        <!-- 步骤2：服务详情 -->
                        <div class="form-step d-none" id="step-2">
                            <h3 class="card-title mb-4">填写服务详情</h3>
                            
                            <!-- 服务类别特定字段 -->
                            <div id="service-specific-fields">
                                <!-- 搬家服务特定字段 -->
                                <div class="service-fields d-none" id="moving-fields">
                                    <h4 class="h5 mb-3">搬家服务详情</h4>
                                    
                                    <div class="mb-3">
                                        <label for="moving_item_size" class="form-label">物品大小</label>
                                        {{ form.moving_item_size(class="form-control") }}
                                        <div class="form-text">选择您需要搬运的物品大小类型</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="moving_item_quantity" class="form-label">物品数量</label>
                                        {{ form.moving_item_quantity(class="form-control", type="number", min="1") }}
                                        <div class="form-text">输入需要搬运的物品数量</div>
                                    </div>
                                    
                                    <div class="mb-3 form-check">
                                        {{ form.moving_has_elevator(class="form-check-input") }}
                                        <label class="form-check-label" for="moving_has_elevator">是否有电梯</label>
                                        <div class="form-text">如果您的住所有电梯，请勾选此项</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="moving_floor_number" class="form-label">楼层</label>
                                        {{ form.moving_floor_number(class="form-control", type="number", min="0") }}
                                        <div class="form-text">输入您的住所楼层</div>
                                    </div>
                                </div>
                                
                                <!-- 接送机特定字段 -->
                                <div class="service-fields d-none" id="pickup-fields">
                                    <h4 class="h5 mb-3">接送机服务详情</h4>
                                    
                                    <div class="mb-3">
                                        <label for="pickup_flight_number" class="form-label">航班号</label>
                                        {{ form.pickup_flight_number(class="form-control") }}
                                        <div class="form-text">输入您的航班号，以便服务提供者查询航班信息</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="pickup_passengers" class="form-label">乘客数量</label>
                                        {{ form.pickup_passengers(class="form-control", type="number", min="1") }}
                                        <div class="form-text">输入需要接送的乘客数量</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="pickup_luggage_count" class="form-label">行李数量</label>
                                        {{ form.pickup_luggage_count(class="form-control", type="number", min="0") }}
                                        <div class="form-text">输入您携带的行李数量</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">服务类型</label>
                                        <div>
                                            {% for subfield in form.pickup_is_arrival %}
                                            <div class="form-check form-check-inline">
                                                {{ subfield(class="form-check-input") }}
                                                {{ subfield.label(class="form-check-label") }}
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <div class="form-text">选择您需要的服务类型</div>
                                    </div>
                                </div>
                                
                                <!-- 装修维修特定字段 -->
                                <div class="service-fields d-none" id="repair-fields">
                                    <h4 class="h5 mb-3">装修维修服务详情</h4>
                                    
                                    <div class="mb-3">
                                        <label for="repair_area" class="form-label">面积（平方米）</label>
                                        {{ form.repair_area(class="form-control", type="number", step="0.01", min="0.1") }}
                                        <div class="form-text">输入需要维修的区域面积</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="repair_type" class="form-label">维修类型</label>
                                        {{ form.repair_type(class="form-control") }}
                                        <div class="form-text">选择您需要的维修类型</div>
                                    </div>
                                    
                                    <div class="mb-3 form-check">
                                        {{ form.repair_materials_included(class="form-check-input") }}
                                        <label class="form-check-label" for="repair_materials_included">是否包含材料</label>
                                        <div class="form-text">如果您希望服务提供者提供维修材料，请勾选此项</div>
                                    </div>
                                </div>
                                
                                <!-- 法律咨询特定字段 -->
                                <div class="service-fields d-none" id="legal-fields">
                                    <h4 class="h5 mb-3">法律咨询服务详情</h4>
                                    
                                    <div class="mb-3">
                                        <label for="legal_case_type" class="form-label">案件类型</label>
                                        {{ form.legal_case_type(class="form-control") }}
                                        <div class="form-text">选择您需要咨询的法律案件类型</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="legal_urgency" class="form-label">紧急程度</label>
                                        {{ form.legal_urgency(class="form-control") }}
                                        <div class="form-text">选择您案件的紧急程度</div>
                                    </div>
                                    
                                    <div class="mb-3 form-check">
                                        {{ form.legal_documents_ready(class="form-check-input") }}
                                        <label class="form-check-label" for="legal_documents_ready">文件是否准备好</label>
                                        <div class="form-text">如果您已经准备好相关法律文件，请勾选此项</div>
                                    </div>
                                </div>
                                
                                <!-- 留学咨询特定字段 -->
                                <div class="service-fields d-none" id="education-fields">
                                    <h4 class="h5 mb-3">留学咨询服务详情</h4>
                                    
                                    <div class="mb-3">
                                        <label for="education_target_country" class="form-label">目标国家</label>
                                        {{ form.education_target_country(class="form-control") }}
                                        <div class="form-text">选择您希望留学的目标国家</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="education_study_level" class="form-label">学习阶段</label>
                                        {{ form.education_study_level(class="form-control") }}
                                        <div class="form-text">选择您希望申请的学习阶段</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="education_field" class="form-label">学习领域</label>
                                        {{ form.education_field(class="form-control") }}
                                        <div class="form-text">选择您希望学习的领域</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary btn-lg px-4 prev-step">上一步</button>
                                <button type="button" class="btn btn-primary btn-lg px-4 next-step">下一步</button>
                            </div>
                        </div>
                        
                        <!-- 步骤3：时间和预算 -->
                        <div class="form-step d-none" id="step-3">
                            <h3 class="card-title mb-4">设置时间和预算</h3>
                            
                            <div class="mb-4">
                                <label for="deadline" class="form-label fw-bold">您希望何时完成这项服务？</label>
                                {{ form.deadline(class="form-control form-control-lg", type="date") }}
                                <div class="form-text">选择您期望服务完成的最晚日期</div>
                                <div class="invalid-feedback">
                                    {% if form.deadline.errors %}
                                        {{ form.deadline.errors[0] }}
                                    {% else %}
                                        请选择截止日期
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="budget" class="form-label fw-bold">您的预算是多少？(可选)</label>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text">€</span>
                                    {{ form.budget(class="form-control", type="number", step="0.01", min="0", placeholder="输入金额") }}
                                </div>
                                <div class="form-text">设置合理的预算可以吸引更多优质服务提供者，如不确定可留空</div>
                                <div class="invalid-feedback">
                                    {% if form.budget.errors %}
                                        {{ form.budget.errors[0] }}
                                    {% else %}
                                        请输入有效的预算金额
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="location" class="form-label fw-bold">服务地点 (可选)</label>
                                {{ form.location(class="form-control form-control-lg", placeholder="输入详细地址或区域") }}
                                <div class="form-text">准确的地点信息有助于匹配附近的服务提供者，如不适用可留空</div>
                                <div class="invalid-feedback">
                                    {% if form.location.errors %}
                                        {{ form.location.errors[0] }}
                                    {% else %}
                                        请输入有效的服务地点
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary btn-lg px-4 prev-step">上一步</button>
                                <button type="button" class="btn btn-primary btn-lg px-4 next-step">下一步</button>
                            </div>
                        </div>
                        
                        <!-- 步骤4：任务描述 -->
                        <div class="form-step d-none" id="step-4">
                            <h3 class="card-title mb-4">任务描述</h3>
                            
                            <div class="alert alert-info mb-4">
                                <i class="fas fa-magic me-2"></i>
                                根据您提供的信息，我们已为您自动生成任务标题和描述。您可以直接使用或进行修改。
                            </div>
                            
                            <div class="mb-4">
                                <label for="title" class="form-label fw-bold">任务标题</label>
                                <div class="input-group mb-2">
                                    {{ form.title(class="form-control form-control-lg", placeholder="简短描述您需要的服务，例如：客厅墙面粉刷") }}
                                    <button class="btn btn-outline-primary" type="button" id="generate-title-btn">
                                        <i class="fas fa-magic"></i> 自动生成
                                    </button>
                                </div>
                                <div class="form-text">清晰的标题可以帮助服务提供者更好地理解您的需求</div>
                                <div class="invalid-feedback">
                                    {% if form.title.errors %}
                                        {{ form.title.errors[0] }}
                                    {% else %}
                                        请输入有效的任务标题
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="description" class="form-label fw-bold">详细描述</label>
                                <div class="input-group mb-2">
                                    {{ form.description(class="form-control", rows=5, placeholder="详细描述您的需求，包括具体要求、面积大小、材料偏好等信息") }}
                                    <button class="btn btn-outline-primary" type="button" id="generate-description-btn" style="align-self: flex-start;">
                                        <i class="fas fa-magic"></i> 自动生成
                                    </button>
                                </div>
                                <div class="form-text">详细的描述可以帮助您获得更准确的报价</div>
                                <div class="invalid-feedback">
                                    {% if form.description.errors %}
                                        {{ form.description.errors[0] }}
                                    {% else %}
                                        请输入有效的任务描述
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="additional_info" class="form-label fw-bold">补充信息 (可选)</label>
                                {{ form.additional_info(class="form-control", rows=3, placeholder="添加任何其他您认为重要的信息") }}
                                <div class="form-text">您可以在这里添加任何其他重要信息</div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="task_images" class="form-label fw-bold">上传图片 (可选)</label>
                                {{ form.task_images(class="form-control") }}
                                <div class="form-text">上传相关图片可以帮助服务提供者更好地理解您的需求 (支持jpg, jpeg, png, gif格式)</div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary btn-lg px-4 prev-step">上一步</button>
                                <button type="button" class="btn btn-primary btn-lg px-4 next-step">下一步</button>
                            </div>
                        </div>
                        
                        <!-- 步骤5：确认发布 -->
                        <div class="form-step d-none" id="step-5">
                            <h3 class="card-title mb-4">确认并发布</h3>
                            
                            <div class="task-summary mb-4">
                                <h4 class="h5 mb-3">任务摘要</h4>
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <dl class="row mb-0">
                                            <dt class="col-sm-4">服务类别:</dt>
                                            <dd class="col-sm-8" id="summary-category"></dd>
                                            
                                            <dt class="col-sm-4">任务标题:</dt>
                                            <dd class="col-sm-8" id="summary-title"></dd>
                                            
                                            <dt class="col-sm-4">服务地点:</dt>
                                            <dd class="col-sm-8" id="summary-location"></dd>
                                            
                                            <dt class="col-sm-4">截止日期:</dt>
                                            <dd class="col-sm-8" id="summary-deadline"></dd>
                                            
                                            <dt class="col-sm-4">预算:</dt>
                                            <dd class="col-sm-8" id="summary-budget"></dd>
                                        </dl>
                                        
                                        <div class="mt-3 pt-3 border-top">
                                            <dt class="col-sm-12">任务描述:</dt>
                                            <dd class="col-sm-12" id="summary-description"></dd>
                                            
                                            <div id="summary-additional-info-container" class="mt-3 d-none">
                                                <dt class="col-sm-12">补充信息:</dt>
                                                <dd class="col-sm-12" id="summary-additional-info"></dd>
                                            </div>
                                            
                                            <div id="summary-images-container" class="mt-3 d-none">
                                                <dt class="col-sm-12">上传图片:</dt>
                                                <dd class="col-sm-12" id="summary-images"></dd>
                                            </div>
                                        </div>
                                        
                                        <!-- 服务类别特定字段摘要 -->
                                        <div id="service-specific-summary" class="mt-3 pt-3 border-top">
                                            <!-- 搬家服务特定字段摘要 -->
                                            <div class="service-summary d-none" id="moving-summary">
                                                <h5 class="h6 mb-2">搬家服务详情</h5>
                                                <dl class="row mb-0">
                                                    <dt class="col-sm-4">物品大小:</dt>
                                                    <dd class="col-sm-8" id="summary-moving-size"></dd>
                                                    
                                                    <dt class="col-sm-4">物品数量:</dt>
                                                    <dd class="col-sm-8" id="summary-moving-quantity"></dd>
                                                    
                                                    <dt class="col-sm-4">是否有电梯:</dt>
                                                    <dd class="col-sm-8" id="summary-moving-elevator"></dd>
                                                    
                                                    <dt class="col-sm-4">楼层:</dt>
                                                    <dd class="col-sm-8" id="summary-moving-floor"></dd>
                                                </dl>
                                            </div>
                                            
                                            <!-- 接送机特定字段摘要 -->
                                            <div class="service-summary d-none" id="pickup-summary">
                                                <h5 class="h6 mb-2">接送机服务详情</h5>
                                                <dl class="row mb-0">
                                                    <dt class="col-sm-4">航班号:</dt>
                                                    <dd class="col-sm-8" id="summary-pickup-flight"></dd>
                                                    
                                                    <dt class="col-sm-4">乘客数量:</dt>
                                                    <dd class="col-sm-8" id="summary-pickup-passengers"></dd>
                                                    
                                                    <dt class="col-sm-4">行李数量:</dt>
                                                    <dd class="col-sm-8" id="summary-pickup-luggage"></dd>
                                                    
                                                    <dt class="col-sm-4">服务类型:</dt>
                                                    <dd class="col-sm-8" id="summary-pickup-type"></dd>
                                                </dl>
                                            </div>
                                            
                                            <!-- 装修维修特定字段摘要 -->
                                            <div class="service-summary d-none" id="repair-summary">
                                                <h5 class="h6 mb-2">装修维修服务详情</h5>
                                                <dl class="row mb-0">
                                                    <dt class="col-sm-4">面积:</dt>
                                                    <dd class="col-sm-8" id="summary-repair-area"></dd>
                                                    
                                                    <dt class="col-sm-4">维修类型:</dt>
                                                    <dd class="col-sm-8" id="summary-repair-type"></dd>
                                                    
                                                    <dt class="col-sm-4">是否包含材料:</dt>
                                                    <dd class="col-sm-8" id="summary-repair-materials"></dd>
                                                </dl>
                                            </div>
                                            
                                            <!-- 法律咨询特定字段摘要 -->
                                            <div class="service-summary d-none" id="legal-summary">
                                                <h5 class="h6 mb-2">法律咨询服务详情</h5>
                                                <dl class="row mb-0">
                                                    <dt class="col-sm-4">案件类型:</dt>
                                                    <dd class="col-sm-8" id="summary-legal-case"></dd>
                                                    
                                                    <dt class="col-sm-4">紧急程度:</dt>
                                                    <dd class="col-sm-8" id="summary-legal-urgency"></dd>
                                                    
                                                    <dt class="col-sm-4">文件是否准备好:</dt>
                                                    <dd class="col-sm-8" id="summary-legal-documents"></dd>
                                                </dl>
                                            </div>
                                            
                                            <!-- 留学咨询特定字段摘要 -->
                                            <div class="service-summary d-none" id="education-summary">
                                                <h5 class="h6 mb-2">留学咨询服务详情</h5>
                                                <dl class="row mb-0">
                                                    <dt class="col-sm-4">目标国家:</dt>
                                                    <dd class="col-sm-8" id="summary-education-country"></dd>
                                                    
                                                    <dt class="col-sm-4">学习阶段:</dt>
                                                    <dd class="col-sm-8" id="summary-education-level"></dd>
                                                    
                                                    <dt class="col-sm-4">学习领域:</dt>
                                                    <dd class="col-sm-8" id="summary-education-field"></dd>
                                                </dl>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                发布任务后，服务提供者将能够查看您的任务并提交报价。您可以随时在个人中心查看和管理您的任务。
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary btn-lg px-4 prev-step">上一步</button>
                                <button type="submit" class="btn btn-success btn-lg px-4">发布任务</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- 帮助信息 -->
            <div class="card mt-4 border-0 bg-light">
                <div class="card-body">
                    <h5><i class="fas fa-lightbulb text-warning me-2"></i>小贴士</h5>
                    <p class="mb-0">详细的任务描述和合理的预算可以帮助您更快找到合适的服务提供者。如需帮助，请查看<a href="{{ url_for('main.user_guide') }}">使用指南</a>或<a href="{{ url_for('main.contact') }}">联系我们</a>。</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% block styles %}
<style>
.progress-container {
    padding: 0 10px;
}

.step {
    text-align: center;
    position: relative;
    width: 20%;
}

.step-circle {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 8px;
    font-weight: bold;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.step.active .step-circle {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

.step.completed .step-circle {
    background-color: #198754;
    color: white;
    border-color: #198754;
}

.step-text {
    font-size: 0.85rem;
    color: #6c757d;
    transition: all 0.3s ease;
}

.step.active .step-text,
.step.completed .step-text {
    color: #212529;
    font-weight: 500;
}

.form-step {
    transition: all 0.3s ease;
}

.service-categories {
    max-height: 300px;
    overflow-y: auto;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 获取所有步骤元素
    const steps = document.querySelectorAll('.form-step');
    const progressBar = document.getElementById('form-progress-bar');
    const stepIndicators = document.querySelectorAll('.step');
    const form = document.getElementById('task-form');
    
    // 当前步骤
    let currentStep = 1;
    const totalSteps = steps.length;
    
    // 下一步按钮点击事件
    document.querySelectorAll('.next-step').forEach(button => {
        button.addEventListener('click', function() {
            // 验证当前步骤
            if (validateStep(currentStep)) {
                // 如果验证通过，前进到下一步
                if (currentStep < totalSteps) {
                    goToStep(currentStep + 1);
                }
            }
        });
    });
    
    // 上一步按钮点击事件
    document.querySelectorAll('.prev-step').forEach(button => {
        button.addEventListener('click', function() {
            if (currentStep > 1) {
                goToStep(currentStep - 1);
            }
        });
    });
    
    // 跳转到指定步骤
    function goToStep(stepNumber) {
        // 隐藏所有步骤
        steps.forEach(step => {
            step.classList.add('d-none');
        });
        
        // 显示目标步骤
        document.getElementById(`step-${stepNumber}`).classList.remove('d-none');
        
        // 更新进度条
        const progress = (stepNumber - 1) / (totalSteps - 1) * 100;
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
        
        // 更新步骤指示器
        stepIndicators.forEach((indicator, index) => {
            const step = index + 1;
            indicator.classList.remove('active', 'completed');
            
            if (step === stepNumber) {
                indicator.classList.add('active');
            } else if (step < stepNumber) {
                indicator.classList.add('completed');
            }
        });
        
        // 更新当前步骤
        currentStep = stepNumber;
        
        // 如果是最后一步，更新摘要信息
        if (currentStep === totalSteps) {
            updateSummary();
        }
    }
    
    // 验证当前步骤
    function validateStep(stepNumber) {
        let isValid = true;
        const currentStepElement = document.getElementById(`step-${stepNumber}`);
        
        // 根据当前步骤验证不同的字段
        if (stepNumber === 1) {
            const categorySelect = document.getElementById('service_category');
            if (!categorySelect.value) {
                categorySelect.classList.add('is-invalid');
                isValid = false;
            } else {
                categorySelect.classList.remove('is-invalid');
                
                // 如果选择了服务类别，显示对应的特定字段
                showServiceSpecificFields(categorySelect.value);
            }
        } else if (stepNumber === 2) {
            // 验证服务特定字段
            const categorySelect = document.getElementById('service_category');
            if (categorySelect.value) {
                const parts = categorySelect.value.split('.');
                if (parts.length === 2) {
                    const subCategory = parts[1];
                    
                    // 根据子类别验证特定字段
                    if (subCategory === 'moving') {
                        const itemSize = document.getElementById('moving_item_size');
                        const itemQuantity = document.getElementById('moving_item_quantity');
                        
                        if (!itemSize.value) {
                            itemSize.classList.add('is-invalid');
                            isValid = false;
                        } else {
                            itemSize.classList.remove('is-invalid');
                        }
                        
                        if (!itemQuantity.value || parseInt(itemQuantity.value) < 1) {
                            itemQuantity.classList.add('is-invalid');
                            isValid = false;
                        } else {
                            itemQuantity.classList.remove('is-invalid');
                        }
                    } else if (subCategory === 'pickup') {
                        const passengers = document.getElementById('pickup_passengers');
                        
                        if (!passengers.value || parseInt(passengers.value) < 1) {
                            passengers.classList.add('is-invalid');
                            isValid = false;
                        } else {
                            passengers.classList.remove('is-invalid');
                        }
                    } else if (subCategory === 'repair') {
                        const area = document.getElementById('repair_area');
                        const repairType = document.getElementById('repair_type');
                        
                        if (!area.value || parseFloat(area.value) <= 0) {
                            area.classList.add('is-invalid');
                            isValid = false;
                        } else {
                            area.classList.remove('is-invalid');
                        }
                        
                        if (!repairType.value) {
                            repairType.classList.add('is-invalid');
                            isValid = false;
                        } else {
                            repairType.classList.remove('is-invalid');
                        }
                    } else if (subCategory === 'legal') {
                        const caseType = document.getElementById('legal_case_type');
                        
                        if (!caseType.value) {
                            caseType.classList.add('is-invalid');
                            isValid = false;
                        } else {
                            caseType.classList.remove('is-invalid');
                        }
                    } else if (subCategory === 'education') {
                        const targetCountry = document.getElementById('education_target_country');
                        const studyLevel = document.getElementById('education_study_level');
                        
                        if (!targetCountry.value) {
                            targetCountry.classList.add('is-invalid');
                            isValid = false;
                        } else {
                            targetCountry.classList.remove('is-invalid');
                        }
                        
                        if (!studyLevel.value) {
                            studyLevel.classList.add('is-invalid');
                            isValid = false;
                        } else {
                            studyLevel.classList.remove('is-invalid');
                        }
                    }
                }
            }
        } else if (stepNumber === 3) {
            const deadline = document.getElementById('deadline');
            
            if (!deadline.value) {
                deadline.classList.add('is-invalid');
                isValid = false;
            } else {
                deadline.classList.remove('is-invalid');
            }
            
            // 预算和地点是可选的，不需要验证
        } else if (stepNumber === 4) {
            // 第4步中的字段都是可选的，不需要验证
            // 如果用户没有填写，自动生成标题和描述
            const title = document.getElementById('title');
            const description = document.getElementById('description');
            
            if (!title.value) {
                generateTitle();
            }
            
            if (!description.value) {
                generateDescription();
            }
        }
        
        return isValid;
    }
    
    // 显示服务特定字段
    function showServiceSpecificFields(categoryValue) {
        // 隐藏所有服务特定字段
        document.querySelectorAll('.service-fields').forEach(field => {
            field.classList.add('d-none');
        });
        
        // 如果选择了服务类别，显示对应的特定字段
        if (categoryValue) {
            const parts = categoryValue.split('.');
            if (parts.length === 2) {
                const subCategory = parts[1];
                const fieldId = `${subCategory}-fields`;
                const field = document.getElementById(fieldId);
                
                if (field) {
                    field.classList.remove('d-none');
                }
            }
        }
    }
    
    // 服务类别选择变化事件
    const categorySelect = document.getElementById('service_category');
    categorySelect.addEventListener('change', function() {
        showServiceSpecificFields(this.value);
    });
    
    // 初始化时显示对应的服务特定字段
    if (categorySelect.value) {
        showServiceSpecificFields(categorySelect.value);
    }
    
    // 更新摘要信息
    function updateSummary() {
        const categorySelect = document.getElementById('service_category');
        const categoryText = categorySelect.options[categorySelect.selectedIndex].text;
        document.getElementById('summary-category').textContent = categoryText;
        
        document.getElementById('summary-title').textContent = document.getElementById('title').value || '(未提供)';
        document.getElementById('summary-location').textContent = document.getElementById('location').value || '(未提供)';
        
        const deadline = document.getElementById('deadline').value;
        const formattedDate = new Date(deadline).toLocaleDateString('zh-CN');
        document.getElementById('summary-deadline').textContent = formattedDate;
        
        const budget = document.getElementById('budget').value;
        document.getElementById('summary-budget').textContent = budget ? `€${budget}` : '(未提供)';
        
        document.getElementById('summary-description').textContent = document.getElementById('description').value || '(未提供)';
        
        // 显示补充信息（如果有）
        const additionalInfo = document.getElementById('additional_info').value;
        if (additionalInfo) {
            document.getElementById('summary-additional-info-container').classList.remove('d-none');
            document.getElementById('summary-additional-info').textContent = additionalInfo;
        } else {
            document.getElementById('summary-additional-info-container').classList.add('d-none');
        }
        
        // 显示图片信息（如果有）
        const taskImages = document.getElementById('task_images').files;
        if (taskImages.length > 0) {
            document.getElementById('summary-images-container').classList.remove('d-none');
            document.getElementById('summary-images').textContent = `已上传 ${taskImages.length} 张图片`;
        } else {
            document.getElementById('summary-images-container').classList.add('d-none');
        }
        
        // 隐藏所有服务特定字段摘要
        document.querySelectorAll('.service-summary').forEach(summary => {
            summary.classList.add('d-none');
        });
        
        // 显示对应的服务特定字段摘要
        if (categorySelect.value) {
            const parts = categorySelect.value.split('.');
            if (parts.length === 2) {
                const subCategory = parts[1];
                
                // 搬家服务特定字段摘要
                if (subCategory === 'moving') {
                    document.getElementById('moving-summary').classList.remove('d-none');
                    
                    const itemSizeSelect = document.getElementById('moving_item_size');
                    let itemSizeText = itemSizeSelect.value;
                    if (itemSizeSelect.selectedIndex > 0) {
                        itemSizeText = itemSizeSelect.options[itemSizeSelect.selectedIndex].text;
                    }
                    document.getElementById('summary-moving-size').textContent = itemSizeText;
                    
                    document.getElementById('summary-moving-quantity').textContent = document.getElementById('moving_item_quantity').value || '未指定';
                    document.getElementById('summary-moving-elevator').textContent = document.getElementById('moving_has_elevator').checked ? '是' : '否';
                    document.getElementById('summary-moving-floor').textContent = document.getElementById('moving_floor_number').value || '未指定';
                }
                
                // 接送机特定字段摘要
                else if (subCategory === 'pickup') {
                    document.getElementById('pickup-summary').classList.remove('d-none');
                    
                    document.getElementById('summary-pickup-flight').textContent = document.getElementById('pickup_flight_number').value || '未指定';
                    document.getElementById('summary-pickup-passengers').textContent = document.getElementById('pickup_passengers').value || '未指定';
                    document.getElementById('summary-pickup-luggage').textContent = document.getElementById('pickup_luggage_count').value || '未指定';
                    
                    const pickupType = document.querySelector('input[name="pickup_is_arrival"]:checked');
                    document.getElementById('summary-pickup-type').textContent = pickupType ? (pickupType.value === '1' ? '接机' : '送机') : '未指定';
                }
                
                // 装修维修特定字段摘要
                else if (subCategory === 'repair') {
                    document.getElementById('repair-summary').classList.remove('d-none');
                    
                    const area = document.getElementById('repair_area').value;
                    document.getElementById('summary-repair-area').textContent = area ? `${area} 平方米` : '未指定';
                    
                    const repairTypeSelect = document.getElementById('repair_type');
                    let repairTypeText = repairTypeSelect.value;
                    if (repairTypeSelect.selectedIndex > 0) {
                        repairTypeText = repairTypeSelect.options[repairTypeSelect.selectedIndex].text;
                    }
                    document.getElementById('summary-repair-type').textContent = repairTypeText;
                    
                    document.getElementById('summary-repair-materials').textContent = document.getElementById('repair_materials_included').checked ? '是' : '否';
                }
                
                // 法律咨询特定字段摘要
                else if (subCategory === 'legal') {
                    document.getElementById('legal-summary').classList.remove('d-none');
                    
                    const caseTypeSelect = document.getElementById('legal_case_type');
                    let caseTypeText = caseTypeSelect.value;
                    if (caseTypeSelect.selectedIndex > 0) {
                        caseTypeText = caseTypeSelect.options[caseTypeSelect.selectedIndex].text;
                    }
                    document.getElementById('summary-legal-case').textContent = caseTypeText;
                    
                    const urgencySelect = document.getElementById('legal_urgency');
                    let urgencyText = urgencySelect.value;
                    if (urgencySelect.selectedIndex > 0) {
                        urgencyText = urgencySelect.options[urgencySelect.selectedIndex].text;
                    }
                    document.getElementById('summary-legal-urgency').textContent = urgencyText;
                    
                    document.getElementById('summary-legal-documents').textContent = document.getElementById('legal_documents_ready').checked ? '是' : '否';
                }
                
                // 留学咨询特定字段摘要
                else if (subCategory === 'education') {
                    document.getElementById('education-summary').classList.remove('d-none');
                    
                    const countrySelect = document.getElementById('education_target_country');
                    let countryText = countrySelect.value;
                    if (countrySelect.selectedIndex > 0) {
                        countryText = countrySelect.options[countrySelect.selectedIndex].text;
                    }
                    document.getElementById('summary-education-country').textContent = countryText;
                    
                    const levelSelect = document.getElementById('education_study_level');
                    let levelText = levelSelect.value;
                    if (levelSelect.selectedIndex > 0) {
                        levelText = levelSelect.options[levelSelect.selectedIndex].text;
                    }
                    document.getElementById('summary-education-level').textContent = levelText;
                    
                    const fieldSelect = document.getElementById('education_field');
                    let fieldText = fieldSelect.value;
                    if (fieldSelect.selectedIndex > 0) {
                        fieldText = fieldSelect.options[fieldSelect.selectedIndex].text;
                    }
                    document.getElementById('summary-education-field').textContent = fieldText;
                }
            }
        }
    }
    
    // 自动生成任务标题
    function generateTitle() {
        const categorySelect = document.getElementById('service_category');
        const categoryText = categorySelect.options[categorySelect.selectedIndex].text;
        const location = document.getElementById('location').value;
        let title = '';
        
        // 根据服务类别生成标题
        if (categorySelect.value) {
            const parts = categorySelect.value.split('.');
            if (parts.length === 2) {
                const subCategory = parts[1];
                
                if (subCategory === 'moving') {
                    const itemSize = document.getElementById('moving_item_size');
                    const itemSizeText = itemSize.options[itemSize.selectedIndex].text;
                    const quantity = document.getElementById('moving_item_quantity').value;
                    
                    title = `搬运${quantity}件${itemSizeText}`;
                    if (location) {
                        title += ` - ${location}`;
                    }
                } else if (subCategory === 'pickup') {
                    const isArrival = document.querySelector('input[name="pickup_is_arrival"]:checked');
                    const serviceType = isArrival && isArrival.value === '1' ? '接机' : '送机';
                    const passengers = document.getElementById('pickup_passengers').value;
                    
                    title = `${serviceType}服务 - ${passengers}人`;
                    if (document.getElementById('pickup_flight_number').value) {
                        title += ` - 航班${document.getElementById('pickup_flight_number').value}`;
                    }
                } else if (subCategory === 'repair') {
                    const repairType = document.getElementById('repair_type');
                    const repairTypeText = repairType.options[repairType.selectedIndex].text;
                    
                    title = `${repairTypeText}服务`;
                    if (document.getElementById('repair_area').value) {
                        title += ` - ${document.getElementById('repair_area').value}平方米`;
                    }
                    if (location) {
                        title += ` - ${location}`;
                    }
                } else if (subCategory === 'legal') {
                    const caseType = document.getElementById('legal_case_type');
                    const caseTypeText = caseType.options[caseType.selectedIndex].text;
                    
                    title = `${caseTypeText}法律咨询`;
                } else if (subCategory === 'education') {
                    const country = document.getElementById('education_target_country');
                    const countryText = country.options[country.selectedIndex].text;
                    const level = document.getElementById('education_study_level');
                    const levelText = level.options[level.selectedIndex].text;
                    
                    title = `${countryText}${levelText}留学咨询`;
                } else {
                    title = `${categoryText}服务`;
                }
            }
        }
        
        if (!title) {
            title = `${categoryText}服务`;
        }
        
        document.getElementById('title').value = title;
    }
    
    // 自动生成任务描述
    function generateDescription() {
        const categorySelect = document.getElementById('service_category');
        const categoryText = categorySelect.options[categorySelect.selectedIndex].text;
        const location = document.getElementById('location').value;
        const deadline = document.getElementById('deadline').value;
        const budget = document.getElementById('budget').value;
        let description = '';
        
        // 基本描述开头
        description = `我需要${categoryText}服务。`;
        
        // 添加截止日期
        if (deadline) {
            const formattedDate = new Date(deadline).toLocaleDateString('zh-CN');
            description += `\n\n希望在${formattedDate}前完成。`;
        }
        
        // 添加地点信息
        if (location) {
            description += `\n\n服务地点：${location}。`;
        }
        
        // 添加预算信息
        if (budget) {
            description += `\n\n预算：€${budget}。`;
        }
        
        // 根据服务类别添加特定信息
        if (categorySelect.value) {
            const parts = categorySelect.value.split('.');
            if (parts.length === 2) {
                const subCategory = parts[1];
                
                description += '\n\n具体需求：';
                
                if (subCategory === 'moving') {
                    const itemSize = document.getElementById('moving_item_size');
                    const itemSizeText = itemSize.options[itemSize.selectedIndex].text;
                    const quantity = document.getElementById('moving_item_quantity').value;
                    const hasElevator = document.getElementById('moving_has_elevator').checked;
                    const floor = document.getElementById('moving_floor_number').value;
                    
                    description += `\n- 物品大小：${itemSizeText}`;
                    description += `\n- 物品数量：${quantity}件`;
                    description += `\n- 是否有电梯：${hasElevator ? '是' : '否'}`;
                    if (floor) {
                        description += `\n- 楼层：${floor}层`;
                    }
                } else if (subCategory === 'pickup') {
                    const isArrival = document.querySelector('input[name="pickup_is_arrival"]:checked');
                    const serviceType = isArrival && isArrival.value === '1' ? '接机' : '送机';
                    const passengers = document.getElementById('pickup_passengers').value;
                    const luggage = document.getElementById('pickup_luggage_count').value;
                    const flight = document.getElementById('pickup_flight_number').value;
                    
                    description += `\n- 服务类型：${serviceType}`;
                    description += `\n- 乘客数量：${passengers}人`;
                    if (luggage) {
                        description += `\n- 行李数量：${luggage}件`;
                    }
                    if (flight) {
                        description += `\n- 航班号：${flight}`;
                    }
                } else if (subCategory === 'repair') {
                    const repairType = document.getElementById('repair_type');
                    const repairTypeText = repairType.options[repairType.selectedIndex].text;
                    const area = document.getElementById('repair_area').value;
                    const materials = document.getElementById('repair_materials_included').checked;
                    
                    description += `\n- 维修类型：${repairTypeText}`;
                    if (area) {
                        description += `\n- 面积：${area}平方米`;
                    }
                    description += `\n- 是否包含材料：${materials ? '是' : '否'}`;
                } else if (subCategory === 'legal') {
                    const caseType = document.getElementById('legal_case_type');
                    const caseTypeText = caseType.options[caseType.selectedIndex].text;
                    const urgency = document.getElementById('legal_urgency');
                    const urgencyText = urgency.options[urgency.selectedIndex].text;
                    const documents = document.getElementById('legal_documents_ready').checked;
                    
                    description += `\n- 案件类型：${caseTypeText}`;
                    description += `\n- 紧急程度：${urgencyText}`;
                    description += `\n- 文件是否准备好：${documents ? '是' : '否'}`;
                } else if (subCategory === 'education') {
                    const country = document.getElementById('education_target_country');
                    const countryText = country.options[country.selectedIndex].text;
                    const level = document.getElementById('education_study_level');
                    const levelText = level.options[level.selectedIndex].text;
                    const field = document.getElementById('education_field');
                    const fieldText = field.options[field.selectedIndex].text;
                    
                    description += `\n- 目标国家：${countryText}`;
                    description += `\n- 学习阶段：${levelText}`;
                    description += `\n- 学习领域：${fieldText}`;
                }
            }
        }
        
        description += '\n\n期待您的回复，谢谢！';
        
        document.getElementById('description').value = description;
    }
    
    // 绑定自动生成按钮事件
    document.getElementById('generate-title-btn').addEventListener('click', generateTitle);
    document.getElementById('generate-description-btn').addEventListener('click', generateDescription);
    
    // 设置最小日期为当前日期
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('deadline').min = today;
    
    // 表单提交验证
    form.addEventListener('submit', function(event) {
        if (!validateStep(currentStep)) {
            event.preventDefault();
            event.stopPropagation();
        }
    });
});
</script>
{% endblock %}
{% endblock %}